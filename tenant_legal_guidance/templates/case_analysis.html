<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant Case Analysis - Legal Guidance System</title>
    <!-- Use vis-network like kg-viewer -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <!-- Use marked.js for proper markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            overflow-y: auto; /* allow page to scroll */
        }
        
        h1, h2, h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        
        /* Improve base readability */
        body {
            font-size: 18px;
            line-height: 1.7;
        }
        
        .main-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .input-section {
            background: white;
            padding: 20px;
            border-bottom: 2px solid #d1d9e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        .input-section h1 {
            text-align: center;
            margin-bottom: 24px;
            color: #2c3e50;
            font-size: 32px;
        }
        
        .input-section p {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 24px;
            font-size: 18px;
        }
        
        .input-controls {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 16px;
        }
        
        textarea {
            width: 100%;
            height: 180px; /* larger input */
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            resize: vertical;
            font-family: inherit;
        }
        
        .example-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .example-controls select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .example-controls button {
            padding: 8px 15px;
            font-size: 14px;
            margin: 0;
        }
        
        .example-description {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            padding: 14px 26px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        /* Enhanced Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
            background: white;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .loading.active {
            display: block !important;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-steps {
            text-align: left;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .loading-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .loading-step.active {
            background-color: #e8f4fd;
            color: #2c3e50;
        }
        
        .loading-step.completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .loading-step-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-step-text {
            flex: 1;
        }
        
        .results {
            display: none;
            flex: 1;
            background: #f0f2f5;
        }
        
        .results.active {
            display: block;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            background: white;
            padding: 0 20px;
            margin: 0;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            color: #7f8c8d;
            font-size: 18px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498b9;
            background: #f8f9fa;
        }
        
        .tab-content {
            display: none;
            min-height: auto; /* let content grow and page scroll */
        }
        
        .tab-content.active {
            display: block;
        }
        
        .analysis-content {
            padding: 20px;
            background: white;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Citation badges and sources styling */
        .markdown-content sup.cite {
            background: #eef6ff;
            color: #0b69c7;
            border: 1px solid #cfe5ff;
            border-radius: 6px;
            padding: 1px 5px;
            margin-left: 4px;
            cursor: pointer;
            font-weight: 600;
            user-select: none;
        }
        .markdown-content sup.cite:hover {
            background: #dff0ff;
        }
        .cite-tooltip {
            position: fixed;
            z-index: 1000;
            max-width: 500px;
            background: #ffffff;
            border: 2px solid #3b82f6;
            box-shadow: 0 12px 32px rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .cite-tooltip h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #1e40af;
            font-weight: 600;
        }
        .cite-tooltip blockquote {
            margin: 12px 0;
            padding: 12px 16px;
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            border-radius: 0 6px 6px 0;
            font-style: italic;
            color: #1e40af;
            font-size: 13px;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .cite-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .cite-actions a, .cite-actions button {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            cursor: pointer;
        }
        .authority-badge {
            display: inline-block;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 9999px;
            border: 1px solid #e5e7eb;
            background: #f3f4f6;
            color: #374151;
            margin-left: 6px;
            vertical-align: middle;
        }
        .authority-binding_legal_authority { background: #eefbf2; color: #065f46; border-color: #bbf7d0; }
        .authority-persuasive_authority { background: #eefbf2; color: #065f46; border-color: #bbf7d0; }
        .authority-official_interpretive { background: #f0f9ff; color: #075985; border-color: #bae6fd; }
        .authority-reputable_secondary { background: #fef3c7; color: #92400e; border-color: #fde68a; }
        .authority-practical_self_help { background: #fef3c7; color: #92400e; border-color: #fde68a; }
        .authority-informational_only { background: #f3f4f6; color: #374151; border-color: #e5e7eb; }
        .sources-list li.highlight { background: #fffbeb; transition: background 0.5s ease; }
        
        .sources-list li {
            margin-bottom: 20px;
            padding: 16px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .sources-list li:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: box-shadow 0.2s ease;
        }
        
        .cite-actions {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            align-items: center;
        }
        
        .cite-actions button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .cite-actions button:hover {
            background: #2563eb;
        }
        
        .cite-actions a {
            color: #3b82f6;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
        }
        
        .cite-actions a:hover {
            text-decoration: underline;
        }
        
        .no-sources-message, .error-message {
            padding: 20px;
            text-align: center;
            color: #64748b;
            font-style: italic;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px dashed #cbd5e1;
        }
        
        .error-message {
            color: #dc2626;
            background: #fef2f2;
            border-color: #fecaca;
        }
        
        /* Inline Citation Styles */
        .cite-badge {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 2px;
            transition: background 0.2s;
        }

        .cite-badge:hover {
            background: #2563eb;
        }

        .inline-citation-card {
            margin: 16px 0;
            padding: 16px;
            background: #f8fafc;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            position: relative;
            z-index: 1000;
            transition: all 0.2s ease;
        }

        .inline-citation-card:hover {
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.25);
            transform: translateY(-1px);
        }

        .citation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #cbd5e1;
        }

        .citation-header .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #64748b;
            padding: 0 8px;
        }

        .citation-context {
            font-size: 14px;
            line-height: 1.6;
        }

        .context-before, .context-after {
            color: #64748b;
            font-style: italic;
            margin: 8px 0;
        }

        .citation-quote {
            background: white;
            padding: 12px;
            border-left: 4px solid #3b82f6;
            margin: 12px 0;
            font-weight: 500;
            color: #1e40af;
        }

        .citation-meta {
            font-size: 12px;
            color: #64748b;
            margin: 8px 0;
        }

        .citation-actions {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .citation-actions button,
        .citation-actions a {
            font-size: 13px;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .citation-actions button {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #334155;
        }

        .citation-actions button:hover {
            background: #e2e8f0;
        }

        .citation-actions a {
            background: #3b82f6;
            color: white;
            border: none;
        }

        .citation-actions a:hover {
            background: #2563eb;
        }
        
        /* Enhanced Sources Section */
        .source-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .source-type {
            font-size: 11px;
            background: #e2e8f0;
            color: #475569;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .source-meta {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e2e8f0;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-left: 4px solid #3498db;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .section h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 20px;
        }
        
        .markdown-content {
            line-height: 1.6;
            font-size: 18px;
        }
        
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .markdown-content strong {
            color: #2c3e50;
            font-weight: bold;
        }
        
        .markdown-content em {
            font-style: italic;
            color: #7f8c8d;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .markdown-content li {
            margin: 5px 0;
            font-size: 18px;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #3498db;
            margin: 15px 0;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 0 4px 4px 0;
            display: block !important;
            visibility: visible !important;
        }
        
        /* Specific styles for source quotes */
        .sources-list blockquote {
            margin: 10px 0;
            padding: 12px 16px;
            background: #f0f7ff;
            border-left: 4px solid #2563eb;
            border-radius: 0 6px 6px 0;
            font-style: italic;
            color: #1e40af;
            font-size: 14px;
            line-height: 1.6;
            display: block !important;
            visibility: visible !important;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .markdown-content code {
            background: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .markdown-content pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #ddd;
        }
        
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
        
        /* Graph container with sidebar layout like kg-viewer */
        .graph-container {
            display: flex;
            height: 70vh; /* occupy most of viewport height */
            min-height: 480px; /* ensure usable initial height */
            margin: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            overflow: hidden;
        }
        
        #graph-vis {
            flex: 1;
            height: 100%; /* fill container */
            background: #fafafa;
        }
        
        #sidebar {
            width: 350px;
            flex-shrink: 0;
            height: 100%;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            border-left: 2px solid #d1d9e6;
        }
        
        #details-panel {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-shrink: 0;
            max-height: 50%;
            overflow-y: auto;
        }
        
        #details-panel h3 {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ced4da;
        }
        
        #details-panel p {
            margin: 5px 0;
            word-wrap: break-word;
        }
        
        #details-panel code {
            background-color: #d1d9e6;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        #details-panel a {
            color: #3498db;
            text-decoration: none;
        }
        
        #details-panel a:hover {
            text-decoration: underline;
        }
        
        .entity-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .entity-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .entity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .entity-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .entity-type {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .entity-description {
            color: #7f8c8d;
            margin: 8px 0;
        }
        
        .source-metadata {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .source-metadata strong {
            color: #2c3e50;
        }
        
        .source-metadata a {
            color: #3498db;
            text-decoration: none;
        }
        
        .source-metadata a:hover {
            text-decoration: underline;
        }
        
        /* Debug styles */
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            max-width: 300px;
        }
        
        /* Proof tree styles */
        .proof-tree-toggle {
            background: #f0f4f8;
            border: 1px solid #cbd5e0;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 0;
            transition: background 0.2s;
        }

        .proof-tree-toggle:hover {
            background: #e2e8f0;
        }

        .proof-tree {
            margin-top: 10px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 3px solid #4299e1;
        }

        .proof-tree.collapsed {
            display: none;
        }

        .proof-tree-flow {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .tree-node {
            padding: 12px;
            border-radius: 6px;
            margin: 5px 0;
        }

        .tree-node.type-tenant_issue {
            background: #fed7d7;
            border: 2px solid #fc8181;
        }

        .tree-node.type-law {
            background: #bee3f8;
            border: 2px solid #4299e1;
        }

        .tree-node.type-remedy {
            background: #c6f6d5;
            border: 2px solid #48bb78;
        }

        .tree-node.type-evidence {
            background: #fefcbf;
            border: 2px solid #ecc94b;
        }

        .node-type {
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            color: #4a5568;
            margin-bottom: 4px;
        }

        .node-name {
            font-size: 14px;
            font-weight: 600;
        }

        .tree-edge {
            text-align: center;
            padding: 5px 0;
        }

        .edge-arrow {
            font-size: 24px;
            color: #4a5568;
        }

        .edge-label {
            font-size: 11px;
            color: #718096;
            font-weight: 600;
        }

        .element-row {
            padding: 8px;
            margin: 4px 0;
            background: #f7fafc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .element-status {
            font-size: 16px;
        }

        .element-name {
            font-weight: 600;
            flex: 1;
        }

        .element-evidence {
            font-size: 12px;
            color: #718096;
            font-style: italic;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .input-controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .graph-container {
                flex-direction: column;
                height: auto;
            }
            
            #sidebar {
                width: 100%;
                height: 300px;
            }
        }
        
        /* Proof Chains Styles */
        .overall-strength {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .overall-strength.strong {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }
        
        .overall-strength.moderate {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }
        
        .overall-strength.weak {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }
        
        .proof-chain {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }
        
        .proof-chain-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .proof-chain-issue {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            text-transform: capitalize;
        }
        
        .strength-badge {
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .strength-badge.strong {
            background: #28a745;
            color: white;
        }
        
        .strength-badge.moderate {
            background: #ffc107;
            color: #000;
        }
        
        .strength-badge.weak {
            background: #dc3545;
            color: white;
        }
        
        .proof-section {
            margin-bottom: 15px;
        }
        
        .proof-section-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .evidence-list {
            list-style: none;
            padding-left: 0;
        }
        
        .evidence-list li {
            padding: 8px;
            margin-bottom: 5px;
            border-left: 3px solid #28a745;
            padding-left: 12px;
            background: white;
        }
        
        .evidence-list li.from-case {
            background: #d1fae5;
            border-left-color: #10b981;
            border-left-width: 4px;
            font-weight: 500;
        }
        
        .evidence-list.needed li {
            border-left-color: #dc3545;
        }
        
        .remedy-card {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }
        
        .remedy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .remedy-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .probability-badge {
            background: #007bff;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .probability-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .probability-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .probability-fill.high {
            background: linear-gradient(to right, #28a745, #20c997);
        }
        
        .probability-fill.medium {
            background: linear-gradient(to right, #ffc107, #ff9800);
        }
        
        .probability-fill.low {
            background: linear-gradient(to right, #dc3545, #ff6b6b);
        }
        
        /* Priority Actions Styles */
        .priority-action {
            border-left: 4px solid;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            background: white;
        }
        
        .priority-action.critical {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .priority-action.high {
            border-left-color: #ff6b6b;
            background: #fff8f8;
        }
        
        .priority-action.medium {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        
        .priority-action.low {
            border-left-color: #6c757d;
            background: #f8f9fa;
        }
        
        .priority-label {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
            text-transform: uppercase;
        }
        
        .priority-label.critical {
            background: #dc3545;
            color: white;
        }
        
        .priority-label.high {
            background: #ff6b6b;
            color: white;
        }
        
        .priority-label.medium {
            background: #ffc107;
            color: #000;
        }
        
        .priority-label.low {
            background: #6c757d;
            color: white;
        }
        
        /* Law with Evidence Styles */
        .law-with-evidence {
            margin: 12px 0;
            padding: 14px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        
        .law-header {
            font-size: 15px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .case-application {
            background: #fef3c7;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
            border-left: 3px solid #f59e0b;
        }
        
        .case-application strong {
            color: #92400e;
            font-size: 13px;
        }
        
        .evidence-details {
            margin-top: 10px;
        }
        
        .evidence-toggle {
            cursor: pointer;
            font-size: 13px;
            color: #3b82f6;
            font-weight: 600;
            padding: 6px 12px;
            background: #eff6ff;
            border-radius: 6px;
            user-select: none;
            display: inline-block;
        }
        
        .evidence-toggle:hover {
            background: #dbeafe;
        }
        
        .law-quote {
            margin: 12px 0;
            padding: 14px;
            background: #f0f9ff;
            border-left: 3px solid #0ea5e9;
            font-size: 13px;
            font-style: italic;
            color: #0c4a6e;
            border-radius: 0 6px 6px 0;
            line-height: 1.7;
        }
        
        .source-link-inline {
            font-size: 12px;
            color: #3b82f6;
            text-decoration: none;
            display: inline-block;
            margin-top: 8px;
        }
        
        .source-link-inline:hover {
            text-decoration: underline;
        }
        
        /* Key Findings Section */
        .key-findings-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        .key-findings-section h3 {
            color: white;
            margin-top: 0;
        }
        
        .overall-strength-compact {
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            font-size: 20px;
            margin-bottom: 20px;
        }
        
        .overall-strength-compact.strong {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #10b981;
        }
        
        .overall-strength-compact.moderate {
            background: rgba(251, 191, 36, 0.2);
            border: 2px solid #fbbf24;
        }
        
        .overall-strength-compact.weak {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
        }
        
        .issue-compact {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .issue-name {
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .strength-badge-mini {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .strength-badge-mini.strong { background: #10b981; }
        .strength-badge-mini.moderate { background: #fbbf24; color: #000; }
        .strength-badge-mini.weak { background: #ef4444; }
        
        .strength-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .strength-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        .strength-fill.strong { background: #10b981; }
        .strength-fill.moderate { background: #fbbf24; }
        .strength-fill.weak { background: #ef4444; }
        
        .priority-actions-compact {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 16px;
            border-radius: 8px;
        }
        
        .priority-actions-compact h4 {
            margin-top: 0;
            color: white;
        }
        
        .priority-actions-compact ol {
            margin: 8px 0 0 0;
            padding-left: 24px;
        }
        
        .priority-actions-compact li {
            margin: 8px 0;
            font-size: 16px;
        }
        
        
        /* Collapsible Sections */
        .section.collapsible.collapsed .section-content {
            display: none;
        }
        
        .section.collapsible h3 {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
        }
        
        .section.collapsible h3:hover {
            background: #f8f9fa;
            padding: 8px;
            margin: -8px;
            border-radius: 4px;
        }
        
        .toggle-icon {
            display: inline-block;
            transition: transform 0.2s;
            margin-right: 8px;
            font-size: 14px;
        }
        
        /* Proof Chain Accordions */
        .proof-chain.accordion {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        
        .proof-chain-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #f8fafc;
            cursor: pointer;
            user-select: none;
        }
        
        .proof-chain-header:hover {
            background: #f1f5f9;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .proof-chain-content {
            padding: 16px;
            max-height: 2000px;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .proof-chain-content.collapsed {
            max-height: 0;
            padding: 0 16px;
            overflow: hidden;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .trust-stats {
                grid-template-columns: 1fr;
            }
            
            .key-findings-section {
                padding: 16px;
            }
            
            .stat-number {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Input section at top -->
        <div class="input-section">
            <h1>üèõÔ∏è Tenant Case Analysis</h1>
            <p>Get legal guidance for your tenant case using our AI-powered analysis system</p>
            
            <div class="input-controls">
                <div class="input-group">
                    <h3>üìù Describe Your Case</h3>
                    <textarea id="caseText" placeholder="Describe your tenant case here... Include details about what happened, when, what notices you received, any court dates, and your rent status."></textarea>
                </div>
                
                <div class="input-group">
                    <h3>üí° Try an Example Case</h3>
                    <div class="example-controls">
                        <select id="exampleSelect" onchange="updateExampleDescription()">
                            <option value="">-- Select an example case --</option>
                        </select>
                        <button onclick="loadExampleCase()" id="loadExampleBtn" disabled>üìã Load</button>
                    </div>
                    <div id="exampleDescription" class="example-description" style="display: none;">
                        <p id="exampleDescText"></p>
                    </div>
                </div>
                
                <div class="input-group">
                    <h3>üîç Analysis</h3>
                    <div class="button-group">
                        <button onclick="analyzeCase()" id="analyzeBtn">Analyze Case</button>
                        <button onclick="clearAnalysis()" id="clearBtn" style="background-color: #95a5a6;">Clear</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Loading indicator -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <h2>üîç Analyzing your case...</h2>
            <p>This may take a moment while we process your case and retrieve relevant legal information.</p>
            
            <div class="loading-steps">
                <div class="loading-step" id="step1">
                    <div class="loading-step-icon">‚è≥</div>
                    <div class="loading-step-text">Extracting key legal terms...</div>
                </div>
                <div class="loading-step" id="step2">
                    <div class="loading-step-icon">üîç</div>
                    <div class="loading-step-text">Searching knowledge graph for relevant laws...</div>
                </div>
                <div class="loading-step" id="step3">
                    <div class="loading-step-icon">ü§ñ</div>
                    <div class="loading-step-text">Generating legal analysis with AI...</div>
                </div>
                <div class="loading-step" id="step4">
                    <div class="loading-step-icon">üìã</div>
                    <div class="loading-step-text">Formatting results...</div>
                </div>
            </div>
        </div>

        <!-- Results section -->
        <div id="results" class="results">
            <div class="tabs">
                <button class="tab active" onclick="showTab('analysis', event)">üìã Legal Analysis</button>
                <button class="tab" onclick="showTab('graph', event)">üï∏Ô∏è Knowledge Graph</button>
                <button class="tab" onclick="showTab('entities', event)">üìö Entities & Sources</button>
                <button class="tab" onclick="showTab('debug', event)">üîç Debug Info</button>
            </div>
            
            <!-- Analysis Tab -->
            <div id="analysis-tab" class="tab-content active">
                <div class="analysis-content">
                    <div class="section">
                        <h3>üìã Case Summary</h3>
                        <div id="caseSummary" class="markdown-content"></div>
                    </div>
                    
                    <!-- NEW: Key Findings Section -->
                    <div class="section key-findings-section" id="keyFindings" style="display: none;">
                        <h3>‚≠ê Key Findings</h3>
                        <div id="keyFindingsContent"></div>
                    </div>
                    
                    <!-- Enhanced Analysis: Proof Chains (shown when available) -->
                    <div id="proofChainsSection" class="section" style="display: none;">
                        <h3>üîó Legal Proof Chains</h3>
                        <div id="overallStrength" class="overall-strength"></div>
                        <div id="proofChains" class="proof-chains-container"></div>
                    </div>
                    
                    <!-- Priority Actions (shown when available) -->
                    <div id="priorityActionsSection" class="section" style="display: none;">
                        <h3>üéØ Priority Actions</h3>
                        <div id="priorityActions" class="priority-actions-container"></div>
                    </div>

                    <!-- Collapsible Full Analysis Section -->
                    <div class="section collapsible collapsed" id="fullAnalysisSection">
                        <h3 onclick="toggleSection('fullAnalysisSection')">
                            <span class="toggle-icon">‚ñ∂</span> Full Legal Analysis & Details
                        </h3>
                        <div class="section-content">
                            <div class="section">
                                <h3>‚öñÔ∏è Legal Issues</h3>
                                <div id="legalIssues" class="markdown-content"></div>
                            </div>

                            <div class="section">
                                <h3>üìú Relevant Laws</h3>
                                <div id="relevantLaws" class="markdown-content"></div>
                            </div>

                            <div class="section">
                                <h3>‚úÖ Recommended Actions</h3>
                                <div id="recommendedActions" class="markdown-content"></div>
                            </div>

                            <div class="section">
                                <h3>üìÑ Evidence Needed</h3>
                                <div id="evidenceNeeded" class="markdown-content"></div>
                            </div>

                            <div class="section">
                                <h3>üèõÔ∏è Legal Resources</h3>
                                <div id="legalResources" class="markdown-content"></div>
                            </div>

                            <div class="section">
                                <h3>‚ö†Ô∏è Risk Assessment</h3>
                                <div id="riskAssessment" class="markdown-content"></div>
                            </div>

                            <div class="section">
                                <h3>üöÄ Next Steps</h3>
                                <div id="nextSteps" class="markdown-content"></div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h3>üîó Sources</h3>
                        <div id="sourcesPanel" class="markdown-content"></div>
                    </div>
                </div>
            </div>
        
            <!-- Graph Tab with sidebar like kg-viewer -->
            <div id="graph-tab" class="tab-content">
                <div class="graph-container">
                    <div id="graph-vis"></div>
                    <div id="sidebar">
                        <h3>Graph Details</h3>
                        <div id="details-panel">
                            <h3>Selection Details</h3>
                            <p>Click on a node or edge to see details here.</p>
                        </div>
                        <div class="entity-list">
                            <h3>Retrieved Entities</h3>
                            <div id="entitiesList"></div>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Entities Tab -->
            <div id="entities-tab" class="tab-content">
                <div class="analysis-content">
                    <h2>üìö Retrieved Entities & Sources</h2>
                    <div id="entitiesListFull"></div>
                </div>
            </div>
            
            <!-- Debug Tab -->
            <div id="debug-tab" class="tab-content">
                <div class="analysis-content">
                    <h2>üîç Retrieval Debug Info</h2>
                    <p style="color: #666;">This panel shows what was retrieved from the knowledge graph and vector store to generate the analysis.</p>
                    
                    <div class="section">
                        <h3>üìä Vector Search Results (Qdrant)</h3>
                        <div id="debugChunks"></div>
                    </div>
                    
                    <div class="section">
                        <h3>üóÇÔ∏è Entity Search Results (ArangoDB)</h3>
                        <div id="debugEntities"></div>
                    </div>
                    
                    <div class="section">
                        <h3>üîó Citations Mapping</h3>
                        <div id="debugCitations"></div>
                    </div>
                    
                    <div class="section">
                        <h3>üìà Retrieval Stats</h3>
                        <div id="debugStats"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug info -->
    <div id="debugInfo" class="debug-info" style="display: none;">
        <div>Status: <span id="debugStatus">Ready</span></div>
        <div>Loading: <span id="debugLoading">false</span></div>
        <div>API Call: <span id="debugApiCall">none</span></div>
    </div>

    <script>
        let exampleCases = [];
        let currentEntitiesData = null;
        let currentDebugData = null;
        let network = null;
        let graphData = { nodes: [], edges: [] };
        let selectedNodeId = null;
        let selectedEdgeId = null;
        let loadingInterval = null;

        // Debug function
        function debugLog(message) {
            console.log('[DEBUG]', message);
            document.getElementById('debugStatus').textContent = message;
        }

        function showDebugInfo() {
            document.getElementById('debugInfo').style.display = 'block';
        }

        // Configure marked.js for better markdown parsing
        marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false,
            smartLists: true,
            smartypants: true
        });

        // Entity type styling like kg-viewer
        const entityColors = {
            'TENANT_ISSUE': '#e74c3c',
            'STATUTE': '#2980b9',
            'REGULATION': '#3498db',
            'CASE': '#f1c40f',
            'REMEDY': '#2ecc71',
            'EVIDENCE_TYPE': '#9b59b6',
            'LEGAL_PROCEDURE': '#e67e22',
            'LEGAL_CONCEPT': '#1abc9c',
            'JURISDICTION': '#7f8c8d',
            'DEFAULT': '#bdc3c7'
        };

        const entityShapes = {
            'TENANT_ISSUE': 'star',
            'STATUTE': 'box',
            'REGULATION': 'box',
            'CASE': 'ellipse',
            'REMEDY': 'diamond',
            'EVIDENCE_TYPE': 'triangle',
            'LEGAL_PROCEDURE': 'hexagon',
            'LEGAL_CONCEPT': 'dot',
            'JURISDICTION': 'square',
            'DEFAULT': 'ellipse'
        };

        // Use DOMContentLoaded instead of load for faster initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - initializing...');
            loadExampleCases();
            showDebugInfo();
            debugLog('Page loaded');
        });
        
        // Also try on window load as backup
        window.addEventListener('load', function() {
            console.log('Window loaded');
            // Check if dropdown is populated, if not try again
            const select = document.getElementById('exampleSelect');
            if (select && select.options.length <= 1) {
                console.warn('Example cases not loaded, retrying...');
                loadExampleCases();
            }
        });

        // Store case text globally for evidence matching
        let currentCaseText = '';
        
        async function analyzeCase(forceRefresh = false) {
            console.log('=== ANALYZE CASE START ===');
            console.log('Force refresh:', forceRefresh);
            const caseText = document.getElementById('caseText').value.trim();
            currentCaseText = caseText; // Store for evidence highlighting
            const select = document.getElementById('exampleSelect');
            const exampleId = select && select.value ? select.value : null;
            
            if (!caseText) {
                alert('Please describe your case before analyzing.');
                return;
            }

            debugLog('Starting analysis...');
            console.log('Starting case analysis...', { caseText: caseText.substring(0, 100), exampleId });

            // Check cache for example cases
            if (exampleId && !forceRefresh) {
                const cachedAnalysis = localStorage.getItem('analysis_' + exampleId);
                const cachedEntities = localStorage.getItem('entities_' + exampleId);
                if (cachedAnalysis && cachedEntities) {
                    console.log('Using cached analysis');
                    debugLog('Using cached analysis');
                    displayResults(JSON.parse(cachedAnalysis));
                    currentEntitiesData = JSON.parse(cachedEntities);
                    showTab('graph');
                    setTimeout(() => {
                        createGraph(currentEntitiesData);
                    }, 200);
                    return;
                }
            }

            // Show enhanced loading state
            console.log('About to show loading state...');
            debugLog('Showing loading state...');
            showLoadingState();
            document.getElementById('results').classList.remove('active');
            document.getElementById('analyzeBtn').disabled = true;
            hideRefreshButton();

            try {
                const body = { case_text: caseText };
                if (exampleId) body.example_id = exampleId;
                body.force_refresh = !!forceRefresh;
                
                console.log('Sending request to API...', body);
                debugLog('Sending API request...');
                document.getElementById('debugApiCall').textContent = 'in progress';
                
                // Use enhanced endpoint for better analysis with proof chains
                const response = await fetch('/api/analyze-case-enhanced', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...body,
                        jurisdiction: 'NYC'  // Default to NYC for now
                    })
                });

                console.log('API response status:', response.status);
                debugLog(`API response: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const data = await response.json();
                console.log('API response data:', data);
                debugLog('API response received');
                document.getElementById('debugApiCall').textContent = 'completed';
                
                displayResults(data);
                
                // Fetch entities for graph
                try {
                    console.log('Fetching entities...');
                    debugLog('Fetching entities...');
                    const entitiesResponse = await fetch('/api/retrieve-entities', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            case_text: caseText
                        })
                    });
                    
                    if (entitiesResponse.ok) {
                        const entitiesData = await entitiesResponse.json();
                        console.log('Entities data:', entitiesData);
                        currentEntitiesData = entitiesData;
                        
                        // Store debug data (combine entities response with chunks from hybrid search)
                        currentDebugData = {
                            retrievalData: entitiesData,
                            analysisData: data
                        };
                        
                        // Populate debug tab
                        populateDebugPanel(currentDebugData);
                        
                        showTab('graph');
                        setTimeout(() => {
                            createGraph(entitiesData);
                        }, 200);
                        
                        // Cache both analysis and entities
                        if (exampleId) {
                            localStorage.setItem('analysis_' + exampleId, JSON.stringify(data));
                            localStorage.setItem('entities_' + exampleId, JSON.stringify(entitiesData));
                        }
                    } else {
                        console.error('Entities API error:', entitiesResponse.status);
                    }
                } catch (error) {
                    console.error('Error fetching entities:', error);
                    showTab('analysis');
                }
            } catch (error) {
                console.error('Error:', error);
                debugLog(`Error: ${error.message}`);
                alert('Error analyzing case: ' + error.message);
            } finally {
                debugLog('Hiding loading state...');
                hideLoadingState();
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('debugApiCall').textContent = 'none';
            }
        }

        function showLoadingState() {
            console.log('Showing loading state...');
            const loading = document.getElementById('loading');
            if (!loading) {
                console.error('Loading element not found!');
                return;
            }
            loading.classList.add('active');
            document.getElementById('debugLoading').textContent = 'true';
            
            // Animate loading steps
            const steps = ['step1', 'step2', 'step3', 'step4'];
            let currentStep = 0;
            
            // Clear any existing interval
            if (loadingInterval) {
                clearInterval(loadingInterval);
            }
            
            loadingInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    // Mark previous step as completed
                    if (currentStep > 0) {
                        document.getElementById(steps[currentStep - 1]).classList.add('completed');
                        document.getElementById(steps[currentStep - 1]).querySelector('.loading-step-icon').textContent = '‚úÖ';
                    }
                    
                    // Mark current step as active
                    document.getElementById(steps[currentStep]).classList.add('active');
                    document.getElementById(steps[currentStep]).querySelector('.loading-step-icon').textContent = '‚è≥';
                    
                    currentStep++;
                } else {
                    clearInterval(loadingInterval);
                }
            }, 2000); // Change step every 2 seconds
        }

        function hideLoadingState() {
            console.log('Hiding loading state...');
            const loading = document.getElementById('loading');
            loading.classList.remove('active');
            document.getElementById('debugLoading').textContent = 'false';
            
            // Clear interval
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }
            
            // Reset all steps
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                step.classList.remove('active', 'completed');
                step.querySelector('.loading-step-icon').textContent = '‚è≥';
            });
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const isCollapsed = section.classList.contains('collapsed');
            const icon = section.querySelector('.toggle-icon');
            
            if (isCollapsed) {
                section.classList.remove('collapsed');
                if (icon) icon.textContent = '‚ñº';
            } else {
                section.classList.add('collapsed');
                if (icon) icon.textContent = '‚ñ∂';
            }
        }
        
        function toggleProofChain(idx) {
            const content = document.getElementById(`proof-chain-${idx}`);
            if (!content) return;
            
            const header = document.querySelector(`[onclick*="toggleProofChain(${idx})"]`);
            const icon = header ? header.querySelector('.toggle-icon') : null;
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                if (icon) icon.textContent = '‚ñº';
            } else {
                content.classList.add('collapsed');
                if (icon) icon.textContent = '‚ñ∂';
            }
        }
        
        function displayKeyFindings(data) {
            const keyFindingsSection = document.getElementById('keyFindings');
            const keyFindingsContent = document.getElementById('keyFindingsContent');
            
            if (!keyFindingsContent || !data.proof_chains || data.proof_chains.length === 0) {
                return;
            }
            
            keyFindingsSection.style.display = 'block';
            
            const topIssues = data.proof_chains.slice(0, 3); // Top 3 only
            const overallStrength = data.overall_strength || 'Unknown';
            
            let html = `
                <div class="overall-strength-compact ${overallStrength.toLowerCase()}">
                    <strong>Overall Case Strength:</strong> ${overallStrength}
                </div>
                <div class="top-issues">
                    <h4 style="color: white; margin-bottom: 12px;">Primary Issues:</h4>
            `;
            
            topIssues.forEach((chain, idx) => {
                const issue = chain.issue.replace(/_/g, ' ');
                const strength = chain.strength_assessment || 'weak';
                const percentage = Math.round((chain.strength_score || 0) * 100);
                
                html += `
                    <div class="issue-compact">
                        <div class="issue-header">
                            <span class="issue-name">${escapeHtml(issue)}</span>
                            <span class="strength-badge-mini ${strength}">${strength} ${percentage}%</span>
                        </div>
                        <div class="strength-bar">
                            <div class="strength-fill ${strength}" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            // Add top priority actions (max 3)
            if (data.priority_actions && data.priority_actions.length > 0) {
                html += `
                    <div class="priority-actions-compact">
                        <h4>Immediate Next Steps:</h4>
                        <ol>
                `;
                data.priority_actions.slice(0, 3).forEach(action => {
                    html += `<li><strong>${escapeHtml(action.action || '')}</strong></li>`;
                });
                html += `</ol></div>`;
            }
            
            keyFindingsContent.innerHTML = html;
        }
        
        
        function displayProofChains(data) {
            const section = document.getElementById('proofChainsSection');
            const strengthDiv = document.getElementById('overallStrength');
            const chainsDiv = document.getElementById('proofChains');
            
            if (!section || !strengthDiv || !chainsDiv) return;
            
            // Show section
            section.style.display = 'block';
            
            // Display overall strength
            const strength = data.overall_strength || 'Unknown';
            strengthDiv.className = `overall-strength ${strength.toLowerCase()}`;
            strengthDiv.textContent = `Overall Case Strength: ${strength}`;
            
            // Render each proof chain as accordion
            let html = '';
            data.proof_chains.forEach((chain, idx) => {
                const issue = chain.issue.replace(/_/g, ' ');
                const isExpanded = idx === 0; // Only first one expanded
                
                html += `
                    <div class="proof-chain accordion">
                        <div class="proof-chain-header" onclick="toggleProofChain(${idx})">
                            <div class="header-left">
                                <span class="toggle-icon">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                <span class="proof-chain-issue">${escapeHtml(issue)}</span>
                            </div>
                            <span class="strength-badge ${chain.strength_assessment || 'weak'}">
                                ${chain.strength_assessment || 'weak'} (${Math.round((chain.strength_score || 0) * 100)}%)
                            </span>
                        </div>
                        <div class="proof-chain-content ${isExpanded ? '' : 'collapsed'}" id="proof-chain-${idx}">
                        
                        ${chain.applicable_laws && chain.applicable_laws.length > 0 ? `
                            <div class="proof-section">
                                <div class="proof-section-title">üìú Applicable Laws:</div>
                                <ul style="list-style: none; padding: 0;">
                                    ${chain.applicable_laws.map(law => {
                                        const citation = law.citation || '';
                                        const cite = data.citations?.[citation];
                                        const quote = cite?.quote || '';
                                        const howApplies = law.how_it_applies_to_this_case || '';
                                        
                                        return `
                                            <li class="law-with-evidence">
                                                <div class="law-header">
                                                    <strong>${escapeHtml(law.name || '')}</strong>: ${escapeHtml(law.key_provision || '')} 
                                                    <sup class="cite" data-cite="${citation}">${citation}</sup>
                                                </div>
                                                ${howApplies ? `
                                                    <div class="case-application">
                                                        <strong>üéØ How this applies to your case:</strong><br>
                                                        ${escapeHtml(howApplies)}
                                                    </div>
                                                ` : ''}
                                                ${quote ? `
                                                    <details class="evidence-details">
                                                        <summary class="evidence-toggle">üìñ Show Legal Text (${quote.length} chars)</summary>
                                                        <blockquote class="law-quote">"${escapeHtml(quote)}"</blockquote>
                                                        ${cite.anchor_url ? `<a href="${cite.anchor_url}" target="_blank" class="source-link-inline">Read full source ‚Üí</a>` : ''}
                                                    </details>
                                                ` : ''}
                                            </li>
                                        `;
                                    }).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${chain.evidence_present && chain.evidence_present.length > 0 ? `
                            <div class="proof-section">
                                <div class="proof-section-title">‚úÖ Evidence Present in Your Case:</div>
                                <ul class="evidence-list">
                                    ${chain.evidence_present.map(e => {
                                        // Check if this evidence item references case text
                                        const lowerE = e.toLowerCase();
                                        const fromCase = lowerE.includes('tenant mentioned') || 
                                                         lowerE.includes('tenant stated') ||
                                                         lowerE.includes('case shows') ||
                                                         (currentCaseText && e.split(' ').slice(0,4).some(word => 
                                                             word.length > 3 && currentCaseText.toLowerCase().includes(word.toLowerCase())
                                                         ));
                                        return `<li class="${fromCase ? 'from-case' : ''}">${fromCase ? 'üìã ' : ''}${escapeHtml(e)}</li>`;
                                    }).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${chain.evidence_needed && chain.evidence_needed.length > 0 && chain.evidence_needed[0] !== 'Not found in sources' ? `
                            <div class="proof-section">
                                <div class="proof-section-title">‚ùå Evidence Needed:</div>
                                <ul class="evidence-list needed">
                                    ${chain.evidence_needed.map(e => `<li>${escapeHtml(e)}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${chain.remedies && chain.remedies.length > 0 ? `
                            <div class="proof-section">
                                <div class="proof-section-title">‚öñÔ∏è Available Remedies:</div>
                                ${chain.remedies.slice(0, 3).map(remedy => {
                                    const prob = remedy.estimated_probability || 0;
                                    const probClass = prob > 0.7 ? 'high' : prob > 0.4 ? 'medium' : 'low';
                                    return `
                                        <div class="remedy-card">
                                            <div class="remedy-header">
                                                <span class="remedy-name">${escapeHtml(remedy.name)}</span>
                                                <span class="probability-badge">${Math.round(prob * 100)}% success rate</span>
                                            </div>
                                            <div class="probability-bar">
                                                <div class="probability-fill ${probClass}" style="width: ${prob * 100}%"></div>
                                            </div>
                                            <div style="font-size: 14px; color: #666;">
                                                ${escapeHtml(remedy.potential_outcome || '')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                        
                        ${chain.reasoning ? `
                            <div class="proof-section" style="font-size: 14px; color: #666; font-style: italic;">
                                <strong>Analysis:</strong> ${escapeHtml(chain.reasoning)}
                            </div>
                        ` : ''}
                        
                        ${chain.graph_chains && chain.graph_chains.length > 0 ? `
                            <div class="proof-section">
                                <button class="proof-tree-toggle" onclick="toggleProofTree(${idx})">
                                    üå≥ Show Graph Path (${chain.verification_status?.graph_path_exists !== false ? '‚úì Verified' : '‚ö†Ô∏è Unverified'})
                                </button>
                                <div id="proof-tree-${idx}" class="proof-tree collapsed">
                                    ${renderProofTree(chain.graph_chains[0])}
                                </div>
                            </div>
                        ` : ''}

                        ${chain.legal_elements && chain.legal_elements.length > 0 ? `
                            <div class="proof-section">
                                <div class="proof-section-title">üìã Required Elements:</div>
                                ${chain.legal_elements.map(elem => `
                                    <div class="element-row">
                                        <span class="element-status">${elem.satisfied ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                                        <span class="element-name">${escapeHtml(elem.element_name)}</span>
                                        ${elem.satisfied && elem.evidence ? `<span class="element-evidence">(${elem.evidence.join(', ')})</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        </div>
                    </div>
                `;
            });
            
            chainsDiv.innerHTML = html;
        }
        
        function renderProofTree(chainData) {
            if (!chainData || !chainData.chain) return '';
            
            const chain = chainData.chain;
            let html = '<div class="proof-tree-flow">';
            
            for (let i = 0; i < chain.length; i++) {
                const node = chain[i];
                
                if (node.type) {
                    // Entity node
                    const typeLabel = node.type.replace(/_/g, ' ').toUpperCase();
                    html += `
                        <div class="tree-node type-${node.type}">
                            <div class="node-type">${typeLabel}</div>
                            <div class="node-name">${escapeHtml(node.name || '')}</div>
                        </div>
                    `;
                } else if (node.rel) {
                    // Relationship edge
                    html += `
                        <div class="tree-edge">
                            <div class="edge-arrow">‚Üì</div>
                            <div class="edge-label">${node.rel}</div>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            return html;
        }

        function toggleProofTree(idx) {
            const tree = document.getElementById(`proof-tree-${idx}`);
            if (tree) {
                tree.classList.toggle('collapsed');
            }
        }
        
        function displayPriorityActions(actions) {
            const section = document.getElementById('priorityActionsSection');
            const actionsDiv = document.getElementById('priorityActions');
            
            if (!section || !actionsDiv) return;
            
            // Show section
            section.style.display = 'block';
            
            // Render actions
            let html = '';
            actions.forEach(action => {
                const priority = action.priority || 'low';
                html += `
                    <div class="priority-action ${priority}">
                        <div>
                            <span class="priority-label ${priority}">${priority}</span>
                            <strong>${escapeHtml(action.action || '')}</strong>
                        </div>
                        ${action.why ? `<div style="margin-top: 8px; font-size: 14px; color: #666;">
                            <strong>Why:</strong> ${escapeHtml(action.why)}
                        </div>` : ''}
                        ${action.how ? `<div style="margin-top: 5px; font-size: 14px; color: #666;">
                            <strong>How:</strong> ${escapeHtml(action.how)}
                        </div>` : ''}
                        ${action.deadline ? `<div style="margin-top: 5px; font-size: 13px; color: #999;">
                            <strong>Deadline:</strong> ${escapeHtml(action.deadline)}
                        </div>` : ''}
                    </div>
                `;
            });
            
            actionsDiv.innerHTML = html;
        }
        
        // Inline Citation Functions
        function toggleInlineCitation(badge, citationId) {
            const cardId = 'inline-' + citationId;
            const card = document.getElementById(cardId);
            if (!card) {
                // Create and insert card if doesn't exist
                const citation = analysisData.citations[citationId];
                if (!citation) {
                    console.warn('Citation not found:', citationId);
                    return;
                }
                const cardHtml = buildInlineCitationCard(citation, citationId);
                badge.insertAdjacentHTML('afterend', cardHtml);
                
                // Add click-outside-to-close behavior
                setTimeout(() => {
                    document.addEventListener('click', function clickOutsideHandler(e) {
                        const newCard = document.getElementById(cardId);
                        if (newCard && !newCard.contains(e.target) && !badge.contains(e.target)) {
                            newCard.style.display = 'none';
                            document.removeEventListener('click', clickOutsideHandler);
                        }
                    });
                }, 10);
            } else {
                card.style.display = card.style.display === 'none' ? 'block' : 'none';
            }
            // Close other open citations
            document.querySelectorAll('.inline-citation-card').forEach(c => {
                if (c.id !== cardId) c.style.display = 'none';
            });
        }

        function buildInlineCitationCard(citation, id) {
            const quote = citation.quote || '';
            const fullText = citation.full_text || quote;
            const contextBefore = citation.chunk_context_before || '';
            const contextAfter = citation.chunk_context_after || '';
            
            // Find quote position in full text to show surrounding context
            const quoteIndex = fullText.indexOf(quote.substring(0, 100));
            const beforeContext = quoteIndex > 0 ? fullText.substring(Math.max(0, quoteIndex - 300), quoteIndex) : contextBefore;
            const afterContext = quoteIndex >= 0 ? fullText.substring(quoteIndex + quote.length, quoteIndex + quote.length + 300) : contextAfter;
            
            return `
                <div class="inline-citation-card" id="inline-${id}">
                    <div class="citation-header">
                        <strong>[${id}] ${escapeHtml(citation.title || citation.entity_name || 'Source')}</strong>
                        ${citation.authority ? '<span class="authority-badge">' + citation.authority + '</span>' : ''}
                        <button class="close-btn" onclick="closeInlineCitation('inline-${id}')">‚úï</button>
                    </div>
                    <div class="citation-context">
                        ${beforeContext ? '<div class="context-before">...' + escapeHtml(beforeContext) + '</div>' : ''}
                        <div class="citation-quote">"${escapeHtml(quote).replace(/\n/g, '<br>')}"</div>
                        ${afterContext ? '<div class="context-after">' + escapeHtml(afterContext) + '...</div>' : ''}
                    </div>
                    <div class="citation-meta">
                        ${citation.organization ? 'Source: ' + escapeHtml(citation.organization) + ' | ' : ''}
                        ${quote.length} characters
                    </div>
                    <div class="citation-actions">
                        ${citation.anchor_url ? '<a href="' + citation.anchor_url + '" target="_blank">View Full Source ‚Üí</a>' : ''}
                        <button onclick="copyCitationText('${id}')">Copy Quote</button>
                        <button onclick="scrollToSourcesSection('${id}')">View in Sources List</button>
                    </div>
                </div>
            `;
        }

        function closeInlineCitation(cardId) {
            const card = document.getElementById(cardId);
            if (card) card.style.display = 'none';
        }

        function copyCitationText(citationId) {
            const citation = analysisData.citations[citationId];
            if (citation && citation.quote) {
                try {
                    navigator.clipboard.writeText(citation.quote);
                    console.log('Copied citation text to clipboard');
                } catch (e) {
                    console.warn('Failed to copy to clipboard:', e);
                }
            }
        }

        function scrollToSourcesSection(citationId) {
            const sourceElement = document.getElementById(citationId);
            if (sourceElement) {
                showTab('analysis');
                sourceElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                sourceElement.classList.add('highlight');
                setTimeout(() => sourceElement.classList.remove('highlight'), 2000);
            }
        }
        
        function displayResults(data) {
            console.log('Displaying results:', data);
            debugLog('Displaying results...');
            
            // Store data globally for citation functions
            window.analysisData = data;
            
            // NEW: Display Key Findings (top priority)
            displayKeyFindings(data);
            
            // Display enhanced proof chains if available
            if (data.proof_chains && data.proof_chains.length > 0) {
                displayProofChains(data);
            }
            
            // Display priority actions if available
            if (data.priority_actions && data.priority_actions.length > 0) {
                displayPriorityActions(data.priority_actions);
            }
            
            // Display case summary with proper markdown parsing (with optional inline citations)
            const caseSummaryDiv = document.getElementById('caseSummary');
            if (!caseSummaryDiv) {
                console.error('caseSummary element not found');
                return;
            }
            const renderCitationsSuperscripts = (text, citationsMap) => {
                if (!text) return '';
                // Replace [S#] with clickable citation badges
                return text.replace(/\[(S\d+)\]/g, (m, id) => {
                    const exists = citationsMap && citationsMap[id];
                    return exists ? `<span class="cite-badge" data-cite="${id}" onclick="toggleInlineCitation(this, '${id}')">[${id}] üìÑ</span>` : `<span class="cite-badge" style="background: #64748b;">[${id}]</span>`;
                });
            };
            if (data.sections && data.sections.case_summary && data.sections.case_summary.length > 0) {
                const cs = data.sections.case_summary[0];
                const html = marked.parse(renderCitationsSuperscripts(cs.text || data.case_summary || 'No summary available.', data.citations));
                caseSummaryDiv.innerHTML = html;
            } else if (data.case_summary_html) {
                caseSummaryDiv.innerHTML = data.case_summary_html;
            } else {
                caseSummaryDiv.innerHTML = marked.parse(data.case_summary || 'No summary available.');
            }

            // Display all sections with proper markdown parsing
            const sections = [
                { elId: 'legalIssues', dataKey: 'legal_issues', htmlKey: 'legal_issues_html', fallback: 'No specific legal issues identified.' },
                { elId: 'relevantLaws', dataKey: 'relevant_laws', htmlKey: 'relevant_laws_html', fallback: 'No specific laws identified.' },
                { elId: 'recommendedActions', dataKey: 'recommended_actions', htmlKey: 'recommended_actions_html', fallback: 'No specific actions recommended.' },
                { elId: 'evidenceNeeded', dataKey: 'evidence_needed', htmlKey: 'evidence_needed_html', fallback: 'No specific evidence requirements identified.' },
                { elId: 'legalResources', dataKey: 'legal_resources', htmlKey: 'legal_resources_html', fallback: 'No specific legal resources identified.' },
                { elId: 'nextSteps', dataKey: 'next_steps', htmlKey: 'next_steps_html', fallback: 'No specific next steps identified.' }
            ];

            sections.forEach(section => {
                const div = document.getElementById(section.elId);
                if (!div) {
                    console.error(`Element with id "${section.elId}" not found`);
                    return;
                }
                // Prefer structured sections with citations when available
                if (data.sections && data.sections[section.dataKey] && Array.isArray(data.sections[section.dataKey])) {
                    const items = data.sections[section.dataKey];
                    let html = '<ul>';
                    items.forEach(it => {
                        const text = typeof it === 'string' ? it : (it.text || '');
                        const rendered = marked.parse(renderCitationsSuperscripts(text, data.citations));
                        // Render citation badges
                        let citesHtml = '';
                        const cites = (typeof it === 'object' && Array.isArray(it.citations)) ? it.citations : [];
                        if (cites.length > 0) {
                            citesHtml = '<span class="citations">' + cites.map(cid => `<span class="cite-badge" data-cite="${cid}" onclick="toggleInlineCitation(this, '${cid}')">[${cid}] üìÑ</span>`).join(' ') + '</span>';
                        }
                        html += `<li>${rendered} ${citesHtml}</li>`;
                    });
                    html += '</ul>';
                    div.innerHTML = html;
                } else if (data[section.htmlKey]) {
                    div.innerHTML = data[section.htmlKey];
                } else if (data[section.dataKey]) {
                    div.innerHTML = renderListItems(data[section.dataKey], section.fallback);
                } else {
                    div.innerHTML = `<p>${section.fallback}</p>`;
                }
            });

            // Display risk assessment
            const riskAssessmentDiv = document.getElementById('riskAssessment');
            if (!riskAssessmentDiv) {
                console.error('riskAssessment element not found');
                return;
            }
            if (data.sections && data.sections.risk_assessment && data.sections.risk_assessment.length > 0) {
                const ra = data.sections.risk_assessment[0];
                const html = marked.parse(renderCitationsSuperscripts(ra.text || data.risk_assessment || 'No risk assessment available.', data.citations));
                riskAssessmentDiv.innerHTML = html;
            } else if (data.risk_assessment_html) {
                riskAssessmentDiv.innerHTML = data.risk_assessment_html;
            } else {
                riskAssessmentDiv.innerHTML = marked.parse(data.risk_assessment || 'No risk assessment available.');
            }

            // Build Sources panel if citations present
            try {
                const sourcesPanel = document.getElementById('sourcesPanel');
                if (sourcesPanel && data.citations && Object.keys(data.citations).length > 0) {
                    console.log('üîç Building Sources panel with', Object.keys(data.citations).length, 'citations');
                    
                    // Count citations with quotes and debug citation structure
                    const withQuotes = Object.values(data.citations).filter(c => c.quote).length;
                    console.log('üìù Citations with quotes:', withQuotes);
                    
                    // Debug: Log citation structure for troubleshooting
                    Object.entries(data.citations).forEach(([id, c]) => {
                        console.log(`Citation ${id}:`, {
                            title: c.title,
                            entity_name: c.entity_name,
                            quote_length: c.quote ? c.quote.length : 0,
                            has_quote: !!c.quote,
                            organization: c.organization,
                            jurisdiction: c.jurisdiction,
                            authority: c.authority
                        });
                    });
                    
                    const authorityBadge = (auth) => {
                        if (!auth) return '';
                        const key = String(auth).toLowerCase();
                        return `<span class="authority-badge authority-${key}">${auth}</span>`;
                    };
                    const domainFromUrl = (u) => {
                        try { const url = new URL(u); return url.hostname.replace('www.', ''); } catch(e){ return ''; }
                    };
                    let shtml = '<h3>All Legal Sources Referenced</h3><ol class="sources-list">';
                    Object.keys(data.citations).sort((a,b)=>{
                        const ai = parseInt(a.replace('S','')) || 0;
                        const bi = parseInt(b.replace('S','')) || 0;
                        return ai - bi;
                    }).forEach(id => {
                        const c = data.citations[id] || {};
                        const title = (c.title || c.entity_name || 'Source');
                        const org = c.organization ? ` ‚Äî ${c.organization}` : '';
                        const jur = c.jurisdiction ? ` (${c.jurisdiction})` : '';
                        const auth = c.authority || '';
                        const url = c.anchor_url || c.source;
                        const host = url ? domainFromUrl(url) : '';
                        const openBtn = url ? `<a href="${url}" target="_blank" rel="noopener">Open ${host ? '('+host+')' : ''}</a>` : '';
                        // Show full quote with better formatting
                        const quote = c.quote ? `<blockquote>${escapeHtml(c.quote).replace(/\n/g, '<br>')}</blockquote>` : '';
                        const sourceType = c.entity_name && c.entity_name.includes('Chunk from') ? 'Text Chunk' : 'Legal Entity';
                        
                        if (c.quote) {
                            console.log(`  [${id}] has quote: ${c.quote.substring(0, 50)}...`);
                        }
                        
                        shtml += `<li id="${id}">
                            <div class="source-header">
                                <strong>[${id}] ${escapeHtml(title)}</strong>${escapeHtml(org)}${escapeHtml(jur)} ${authorityBadge(auth)}
                                <span class="source-type">${sourceType}</span>
                            </div>
                            <div class="cite-actions">${openBtn}<button data-copy="${id}">Copy Quote</button></div>
                            ${quote}
                            <div class="source-meta">
                                ${c.quote ? `${c.quote.length} characters` : 'No quote available'} | 
                                ${c.authority || 'Unknown authority'}
                            </div>
                        </li>`;
                    });
                    shtml += '</ol>';
                    sourcesPanel.innerHTML = shtml;
                    console.log('‚úÖ Sources panel HTML set, length:', shtml.length);
                    // Wire copy buttons
                    sourcesPanel.querySelectorAll('button[data-copy]').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const id = btn.getAttribute('data-copy');
                            const c = data.citations[id];
                            const text = (c && c.quote) ? c.quote : (c && c.source) ? c.source : id;
                            try { navigator.clipboard.writeText(text); } catch(e){}
                        });
                    });
                } else if (sourcesPanel) {
                    // Show fallback message when no citations available
                    sourcesPanel.innerHTML = '<div class="no-sources-message"><p>No source citations available for this analysis.</p></div>';
                    console.log('‚ö†Ô∏è No citations available for sources panel');
                }
            } catch (e) {
                console.warn('Failed to render sources panel', e);
                const sourcesPanel = document.getElementById('sourcesPanel');
                if (sourcesPanel) {
                    sourcesPanel.innerHTML = '<div class="error-message"><p>Error loading source citations. Please try refreshing the analysis.</p></div>';
                }
            }

            // Wire up citation click handlers
            try {
                const buildTooltipHtml = (c, id) => {
                    if (!c) return '';
                    const title = c.title || c.entity_name || id;
                    const org = c.organization ? ` ‚Äî ${c.organization}` : '';
                    const jur = c.jurisdiction ? ` (${c.jurisdiction})` : '';
                    const auth = c.authority || '';
                    const url = c.anchor_url || c.source;
                    const host = url ? (function(u){try{return new URL(u).hostname.replace('www.','');}catch(e){return '';}})(url) : '';
                    
                    // Show quote prominently with label and better formatting
                    const quote = c.quote ? `
                        <div style="margin: 10px 0;">
                            <strong style="color: #3b82f6; font-size: 12px;">üìú Legal Text:</strong>
                            <blockquote>${escapeHtml(c.quote).replace(/\n/g, '<br>')}</blockquote>
                        </div>
                    ` : '<div style="color: #64748b; font-style: italic; margin: 8px 0;">No quote available for this source.</div>';
                    
                    const openLink = url ? `<a href="${url}" target="_blank" rel="noopener" style="margin-right: 8px;">Open ${host ? '('+host+')' : ''}</a>` : '';
                    return `
                        <h4>${escapeHtml(title)} ${org}${jur} ${auth ? `<span class=\"authority-badge authority-${String(auth).toLowerCase()}\">${escapeHtml(auth)}</span>` : ''}</h4>
                        ${quote}
                        <div class=\"cite-actions\">${openLink}<button data-action=\"copy\">Copy quote</button></div>
                    `;
                };
                let tooltipEl = null;
                const removeTooltip = () => { 
                    if (tooltipEl && tooltipEl.parentNode && tooltipEl.classList.contains('cite-tooltip')) { 
                        tooltipEl.parentNode.removeChild(tooltipEl); 
                        tooltipEl = null; 
                    } 
                };
                document.addEventListener('scroll', removeTooltip, true);
                document.querySelectorAll('sup.cite').forEach(el => {
                    el.addEventListener('click', () => {
                        const id = el.getAttribute('data-cite');
                        const target = document.getElementById(id);
                        if (target) {
                            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            target.classList.add('highlight');
                            setTimeout(()=> target.classList.remove('highlight'), 1500);
                        }
                    });
                    el.addEventListener('mouseenter', () => {
                        const id = el.getAttribute('data-cite');
                        const c = data.citations ? data.citations[id] : null;
                        if (!c) return;
                        removeTooltip();
                        tooltipEl = document.createElement('div');
                        tooltipEl.className = 'cite-tooltip';
                        tooltipEl.innerHTML = buildTooltipHtml(c, id);
                        document.body.appendChild(tooltipEl);
                        const rect = el.getBoundingClientRect();
                        
                        // Improved positioning to prevent off-screen tooltips
                        const tooltipRect = tooltipEl.getBoundingClientRect();
                        const viewportWidth = window.innerWidth;
                        const viewportHeight = window.innerHeight;
                        
                        let top = rect.top + window.scrollY + rect.height + 6;
                        let left = rect.left + window.scrollX;
                        
                        // Adjust horizontal position if tooltip would go off-screen
                        if (left + tooltipRect.width > viewportWidth - 12) {
                            left = viewportWidth - tooltipRect.width - 12;
                        }
                        if (left < 12) {
                            left = 12;
                        }
                        
                        // Adjust vertical position if tooltip would go off-screen
                        if (top + tooltipRect.height > viewportHeight + window.scrollY - 12) {
                            top = rect.top + window.scrollY - tooltipRect.height - 6;
                        }
                        
                        tooltipEl.style.top = `${top}px`;
                        tooltipEl.style.left = `${left}px`;
                        const copyBtn = tooltipEl.querySelector('button[data-action="copy"]');
                        if (copyBtn) {
                            copyBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const id2 = el.getAttribute('data-cite');
                                const c2 = data.citations ? data.citations[id2] : null;
                                const text = c2 && c2.quote ? c2.quote : '';
                                try { navigator.clipboard.writeText(text); } catch(ex){}
                            });
                        }
                    });
                    el.addEventListener('mouseleave', () => {
                        // Add a small delay to prevent flickering when moving mouse
                        setTimeout(() => {
                            removeTooltip();
                        }, 100);
                    });
                });
            } catch (e) {
                console.warn('Failed to attach citation handlers', e);
            }

            // Show results
            document.getElementById('results').classList.add('active');
            showRefreshButton();
            debugLog('Results displayed');
        }

        function renderListItems(items, fallbackText) {
            if (!items || items.length === 0) {
                return `<p>${fallbackText}</p>`;
            }
            
            let html = '<ul>';
            items.forEach(item => {
                const itemHtml = marked.parse(item);
                html += `<li>${itemHtml}</li>`;
            });
            html += '</ul>';
            return html;
        }

        function createGraph(data) {
            console.log('Creating graph with data:', data);
            const graphContainer = document.getElementById('graph-vis');
            if (!graphContainer) {
                console.error('Graph container not found!');
                return;
            }
            
            // Convert entities to vis-network format
            const nodes = (data.entities || []).map(entity => {
                const typeKey = (typeof entity.type === 'string' ? entity.type : String(entity.type)).toUpperCase();
                return {
                    id: entity.id,
                    label: entity.name,
                    title: `Type: ${entity.type}\nID: ${entity.id}`,
                    shape: entityShapes[typeKey] || entityShapes.DEFAULT,
                    color: entityColors[typeKey] || entityColors.DEFAULT,
                    size: 20,
                    originalData: entity
                };
            });
            
            const edges = (data.relationships || []).map((rel, i) => ({
                id: `edge_${i}`,
                from: rel.source_id,
                to: rel.target_id,
                label: rel.type || '',
                title: `Type: ${rel.type}\nConditions: ${rel.conditions || 'N/A'}`,
                arrows: 'to',
                font: { align: 'top' },
                color: '#848484',
                width: 1,
                originalData: rel
            }));
            
            graphData = { nodes, edges };
            
            const options = {
                nodes: {
                    font: { size: 12, color: '#333' },
                    borderWidth: 1,
                    shapeProperties: {
                        useBorderWithImage: true
                    }
                },
                edges: {
                    width: 1,
                    color: '#848484',
                    smooth: {
                        type: 'continuous'
                    },
                    font: {
                        size: 10,
                        color: '#555',
                        strokeWidth: 0
                    }
                },
                physics: {
                    enabled: true,
                    solver: 'forceAtlas2Based',
                    forceAtlas2Based: {
                        gravitationalConstant: -50,
                        centralGravity: 0.01,
                        springLength: 100,
                        springConstant: 0.08,
                        avoidOverlap: 0.5
                    },
                    stabilization: { iterations: 150 }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200
                }
            };

            network = new vis.Network(graphContainer, graphData, options);

            // Event listeners like kg-viewer
            network.on("click", function (params) {
                handleSelection(params);
            });

            network.on("stabilizationIterationsDone", function () {
                console.log("Layout stabilization complete.");
                network.stopSimulation();
                // Disable physics to prevent endless spinning
                network.setOptions({ physics: { enabled: false } });
                try { network.fit({ animation: { duration: 300, easingFunction: 'easeInOutQuad' } }); } catch (e) {}
            });

            // Display entities in sidebar
            displayEntitiesInSidebar(data.entities || []);
        }

        function handleSelection(params) {
            selectedNodeId = null;
            selectedEdgeId = null;

            if (params.nodes.length > 0) {
                selectedNodeId = params.nodes[0];
                const node = graphData.nodes.find(n => n.id === selectedNodeId);
                displayNodeDetails(node);
            } else if (params.edges.length > 0) {
                selectedEdgeId = params.edges[0];
                const edge = graphData.edges.find(e => e.id === selectedEdgeId);
                displayEdgeDetails(edge);
            } else {
                displayDefaultDetails();
            }
        }

        function displayNodeDetails(node) {
            if (!node || !node.originalData) {
                displayDefaultDetails();
                return;
            }
            
            const data = node.originalData;
            const sourceMeta = data.source_metadata || {};
            const provenance = data.provenance || [];
            const mentionsCount = data.mentions_count || 0;
            
            let detailsHtml = `<h3>Entity Details: ${escapeHtml(data.name)}</h3>`;
            detailsHtml += `<p><strong>ID:</strong> <code>${escapeHtml(data.id)}</code></p>`;
            detailsHtml += `<p><strong>Type:</strong> ${escapeHtml(data.type)}</p>`;
            
            if (data.description) {
                detailsHtml += `<p><strong>Description:</strong> ${escapeHtml(data.description)}</p>`;
            }
            
            // Display mentions count if entity appears in multiple sources
            if (mentionsCount > 1) {
                detailsHtml += `<p><strong>üìö Found in ${mentionsCount} sources</strong></p>`;
            }
            
            // Display primary/canonical source
            detailsHtml += `<h4 style="margin-top: 15px; color: #2c3e50;">Primary Source:</h4>`;
            if (sourceMeta.source) {
                const sourceText = sourceMeta.source.startsWith('http')
                    ? `<a href="${escapeHtml(sourceMeta.source)}" target="_blank">${escapeHtml(sourceMeta.source)}</a>`
                    : escapeHtml(sourceMeta.source);
                detailsHtml += `<p><strong>Source:</strong> ${sourceText}</p>`;
            }
            
            if (sourceMeta.organization) {
                detailsHtml += `<p><strong>Organization:</strong> ${escapeHtml(sourceMeta.organization)}</p>`;
            }
            
            if (sourceMeta.title) {
                detailsHtml += `<p><strong>Title:</strong> ${escapeHtml(sourceMeta.title)}</p>`;
            }
            
            if (sourceMeta.jurisdiction) {
                detailsHtml += `<p><strong>Jurisdiction:</strong> ${escapeHtml(sourceMeta.jurisdiction)}</p>`;
            }
            
            if (sourceMeta.authority) {
                detailsHtml += `<p><strong>Authority:</strong> ${escapeHtml(sourceMeta.authority)}</p>`;
            }
            
            if (sourceMeta.created_at) {
                detailsHtml += `<p><strong>Created:</strong> ${escapeHtml(sourceMeta.created_at)}</p>`;
            }
            
            if (sourceMeta.document_type) {
                detailsHtml += `<p><strong>Document Type:</strong> ${escapeHtml(sourceMeta.document_type)}</p>`;
            }
            
            if (sourceMeta.cites && sourceMeta.cites.length > 0) {
                detailsHtml += `<p><strong>Cites:</strong> ${escapeHtml(sourceMeta.cites.join(', '))}</p>`;
            }
            
            // Display all provenance sources if multiple sources exist
            if (provenance && provenance.length > 1) {
                detailsHtml += `<h4 style="margin-top: 15px; color: #2c3e50;">All Sources (${provenance.length}):</h4>`;
                detailsHtml += `<ol style="padding-left: 20px; margin: 10px 0;">`;
                provenance.forEach((prov, idx) => {
                    const provSource = prov.source || {};
                    const provSourceUrl = provSource.source || '';
                    const provTitle = provSource.title || provSourceUrl;
                    const provOrg = provSource.organization || '';
                    const provQuote = prov.quote || '';
                    
                    detailsHtml += `<li style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;">`;
                    if (provSourceUrl) {
                        const sourceText = provSourceUrl.startsWith('http')
                            ? `<a href="${escapeHtml(provSourceUrl)}" target="_blank">${escapeHtml(provTitle)}</a>`
                            : escapeHtml(provTitle);
                        detailsHtml += `<strong>${sourceText}</strong>`;
                    }
                    if (provOrg) {
                        detailsHtml += ` <em>(${escapeHtml(provOrg)})</em>`;
                    }
                    if (provQuote) {
                        detailsHtml += `<br><small style="color: #666;">"${escapeHtml(provQuote.substring(0, 100))}${provQuote.length > 100 ? '...' : ''}"</small>`;
                    }
                    detailsHtml += `</li>`;
                });
                detailsHtml += `</ol>`;
            }
            
            document.getElementById('details-panel').innerHTML = detailsHtml;
        }

        function displayEdgeDetails(edge) {
            if (!edge || !edge.originalData) {
                displayDefaultDetails();
                return;
            }
            
            const data = edge.originalData;
            let detailsHtml = `<h3>Relationship Details</h3>`;
            detailsHtml += `<p><strong>From:</strong> <code>${escapeHtml(data.source_id)}</code></p>`;
            detailsHtml += `<p><strong>To:</strong> <code>${escapeHtml(data.target_id)}</code></p>`;
            detailsHtml += `<p><strong>Type:</strong> ${escapeHtml(data.type)}</p>`;
            
            if (data.conditions) {
                detailsHtml += `<p><strong>Conditions:</strong> ${escapeHtml(data.conditions)}</p>`;
            }
            
            document.getElementById('details-panel').innerHTML = detailsHtml;
        }

        function displayDefaultDetails() {
            document.getElementById('details-panel').innerHTML = '<h3>Selection Details</h3><p>Click on a node or edge to see details here.</p>';
        }

        function displayEntitiesInSidebar(entities) {
            const entitiesList = document.getElementById('entitiesList');
            if (!entities || entities.length === 0) {
                entitiesList.innerHTML = '<p>No entities found for this case.</p>';
                return;
            }
            
            let html = '';
            entities.forEach(entity => {
                const sourceMeta = entity.source_metadata || {};
                const mentionsCount = entity.mentions_count || 0;
                const provenance = entity.provenance || [];
                
                html += `
                    <div class="entity-card">
                        <div class="entity-header">
                            <div class="entity-name">${entity.name}</div>
                            <div class="entity-type">${entity.type}</div>
                        </div>
                        ${mentionsCount > 1 ? `<div style="background: #e8f4fd; padding: 4px 8px; margin: 8px 0; border-radius: 4px; font-size: 12px;"><strong>üìö Found in ${mentionsCount} sources</strong></div>` : ''}
                        <div class="entity-description">${entity.description || 'No description available.'}</div>
                        <div class="source-metadata">
                            <strong>Primary Source:</strong> ${sourceMeta.source || 'Unknown'}<br>
                            <strong>Type:</strong> ${sourceMeta.source_type || 'Unknown'}<br>
                            ${sourceMeta.organization ? `<strong>Organization:</strong> ${sourceMeta.organization}<br>` : ''}
                            ${sourceMeta.title ? `<strong>Title:</strong> ${sourceMeta.title}<br>` : ''}
                            ${sourceMeta.jurisdiction ? `<strong>Jurisdiction:</strong> ${sourceMeta.jurisdiction}<br>` : ''}
                            ${sourceMeta.authority ? `<strong>Authority:</strong> ${sourceMeta.authority}<br>` : ''}
                            ${provenance.length > 1 ? `<strong>Additional sources:</strong> ${provenance.length - 1}<br>` : ''}
                        </div>
                    </div>
                `;
            });
            
            entitiesList.innerHTML = html;
        }

        function displayEntities(entities) {
            const entitiesListFull = document.getElementById('entitiesListFull');
            if (!entities || entities.length === 0) {
                entitiesListFull.innerHTML = '<p>No entities found for this case.</p>';
                return;
            }
            
            let html = '';
            entities.forEach(entity => {
                const sourceMeta = entity.source_metadata || {};
                html += `
                    <div class="entity-card">
                        <div class="entity-header">
                            <div class="entity-name">${entity.name}</div>
                            <div class="entity-type">${entity.type}</div>
                        </div>
                        <div class="entity-description">${entity.description || 'No description available.'}</div>
                        <div class="source-metadata">
                            <strong>Source:</strong> ${sourceMeta.source || 'Unknown'}<br>
                            <strong>Type:</strong> ${sourceMeta.source_type || 'Unknown'}<br>
                            ${sourceMeta.organization ? `<strong>Organization:</strong> ${sourceMeta.organization}<br>` : ''}
                            ${sourceMeta.title ? `<strong>Title:</strong> ${sourceMeta.title}<br>` : ''}
                            ${sourceMeta.jurisdiction ? `<strong>Jurisdiction:</strong> ${sourceMeta.jurisdiction}<br>` : ''}
                            ${sourceMeta.authority ? `<strong>Authority:</strong> ${sourceMeta.authority}<br>` : ''}
                            ${sourceMeta.created_at ? `<strong>Created:</strong> ${sourceMeta.created_at}<br>` : ''}
                            ${sourceMeta.document_type ? `<strong>Document Type:</strong> ${sourceMeta.document_type}<br>` : ''}
                            ${sourceMeta.cites && sourceMeta.cites.length > 0 ? `<strong>Cites:</strong> ${sourceMeta.cites.join(', ')}<br>` : ''}
                        </div>
                    </div>
                `;
            });
            
            entitiesListFull.innerHTML = html;
        }

        function showTab(tabName, evt) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // Show selected tab content
            const tabContent = document.getElementById(tabName + '-tab');
            if (tabContent) {
                tabContent.classList.add('active');
            }
            // Add active class to clicked tab if event is provided
            if (evt && evt.target && evt.target.classList) {
                evt.target.classList.add('active');
            }
            
            // If switching to entities tab, populate it
            if (tabName === 'entities' && currentEntitiesData) {
                displayEntities(currentEntitiesData.entities || []);
            }
            // If switching to graph tab, trigger a fit so it fills space
            if (tabName === 'graph' && network) {
                try { network.fit({ animation: { duration: 300, easingFunction: 'easeInOutQuad' } }); } catch (e) {}
            }
        }

        function clearAnalysis() {
            document.getElementById('caseText').value = '';
            document.getElementById('exampleSelect').value = '';
            document.getElementById('exampleDescription').style.display = 'none';
            document.getElementById('results').classList.remove('active');
            hideLoadingState();
            hideRefreshButton();
            debugLog('Analysis cleared');
        }

        async function loadExampleCases() {
            try {
                console.log('Fetching example cases from /api/example-cases...');
                const response = await fetch('/api/example-cases');
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Example cases data:', data);
                    exampleCases = data.cases || [];
                    
                    const select = document.getElementById('exampleSelect');
                    if (!select) {
                        console.error('Could not find exampleSelect element!');
                        return;
                    }
                    
                    select.innerHTML = '<option value="">-- Select an example case --</option>';
                    exampleCases.forEach(case_item => {
                        const option = document.createElement('option');
                        option.value = case_item.id;
                        option.textContent = case_item.title;
                        select.appendChild(option);
                    });
                    console.log(`Successfully loaded ${exampleCases.length} example cases`);
                } else {
                    console.error('Failed to fetch example cases, status:', response.status);
                }
            } catch (error) {
                console.error('Error loading example cases:', error);
            }
        }

        function updateExampleDescription() {
            const select = document.getElementById('exampleSelect');
            const loadBtn = document.getElementById('loadExampleBtn');
            const descDiv = document.getElementById('exampleDescription');
            const descText = document.getElementById('exampleDescText');
            if (select.value) {
                const selectedCase = exampleCases.find(c => c.id === select.value);
                if (selectedCase) {
                    descText.textContent = selectedCase.description;
                    descDiv.style.display = 'block';
                    loadBtn.disabled = false;
                }
            } else {
                descDiv.style.display = 'none';
                loadBtn.disabled = true;
            }
        }

        function loadExampleCase() {
            const select = document.getElementById('exampleSelect');
            if (select.value) {
                const selectedCase = exampleCases.find(c => c.id === select.value);
                if (selectedCase) {
                    document.getElementById('caseText').value = selectedCase.case_text;
                }
            }
        }

        function showRefreshButton() {
            let btn = document.getElementById('refreshAnalysisBtn');
            if (!btn) {
                btn = document.createElement('button');
                btn.id = 'refreshAnalysisBtn';
                btn.textContent = 'üîÑ Refresh Analysis';
                btn.style.marginLeft = '10px';
                btn.onclick = function() {
                    analyzeCase(true);
                };
                document.getElementById('analyzeBtn').after(btn);
            }
            btn.style.display = 'inline-block';
        }
        
        function hideRefreshButton() {
            const btn = document.getElementById('refreshAnalysisBtn');
            if (btn) btn.style.display = 'none';
        }

        function populateDebugPanel(debugData) {
            if (!debugData) return;
            
            const retrievalData = debugData.retrievalData || {};
            const analysisData = debugData.analysisData || {};
            
            // Populate chunks section
            const debugChunks = document.getElementById('debugChunks');
            if (debugChunks) {
                let chunksHtml = '<p><strong>No chunks retrieved yet. Chunks come from hybrid-search or are embedded in entity retrieval.</strong></p>';
                if (retrievalData.entities && retrievalData.entities.length > 0) {
                    chunksHtml = `<p style="color: #666;">Chunks are retrieved via vector search. Currently showing entity-based retrieval. For chunk details, check the Sources panel in the Analysis tab.</p>`;
                }
                debugChunks.innerHTML = chunksHtml;
            }
            
            // Populate entities section
            const debugEntities = document.getElementById('debugEntities');
            if (debugEntities && retrievalData.entities) {
                const entities = retrievalData.entities.slice(0, 10); // Top 10
                let html = `<p><strong>Retrieved ${retrievalData.total_entities} entities total, showing top 10:</strong></p><table style="width:100%; border-collapse: collapse; margin-top: 10px;">
                    <tr style="background: #f0f2f5; font-weight: bold;">
                        <th style="padding: 8px; border: 1px solid #ddd;">Entity</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">Type</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">Description</th>
                    </tr>`;
                entities.forEach((e, i) => {
                    html += `<tr style="border: 1px solid #ddd;">
                        <td style="padding: 8px; border: 1px solid #ddd;"><code>${escapeHtml(e.id)}</code><br><strong>${escapeHtml(e.name)}</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(e.type)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml((e.description || '').substring(0, 100))}${e.description && e.description.length > 100 ? '...' : ''}</td>
                    </tr>`;
                });
                html += '</table>';
                debugEntities.innerHTML = html;
            }
            
            // Populate citations mapping
            const debugCitations = document.getElementById('debugCitations');
            if (debugCitations && analysisData.citations) {
                const citations = analysisData.citations;
                let html = `<table style="width:100%; border-collapse: collapse;">
                    <tr style="background: #f0f2f5; font-weight: bold;">
                        <th style="padding: 8px; border: 1px solid #ddd;">ID</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">Type</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">Source</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">Has Quote?</th>
                    </tr>`;
                Object.keys(citations).sort((a,b) => {
                    const ai = parseInt(a.replace('S','')) || 0;
                    const bi = parseInt(b.replace('S','')) || 0;
                    return ai - bi;
                }).forEach(id => {
                    const c = citations[id];
                    const isChunk = c.entity_name && c.entity_name.includes('Chunk from');
                    html += `<tr style="border: 1px solid #ddd;">
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>${id}</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${isChunk ? 'Chunk' : 'Entity'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml((c.title || c.entity_name || '').substring(0, 60))}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${c.quote ? '‚úÖ Yes (' + c.quote.length + ' chars)' : '‚ùå No'}</td>
                    </tr>`;
                });
                html += `</table>`;
                debugCitations.innerHTML = html;
            }
            
            // Populate stats
            const debugStats = document.getElementById('debugStats');
            if (debugStats) {
                const citationCount = analysisData.citations ? Object.keys(analysisData.citations).length : 0;
                const quotesCount = analysisData.citations ? Object.values(analysisData.citations).filter(c => c.quote).length : 0;
                const proofChainCount = analysisData.proof_chains ? analysisData.proof_chains.length : 0;
                
                let html = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <strong>Total Entities Retrieved:</strong><br>
                            <span style="font-size: 24px; color: #3498db;">${retrievalData.total_entities || 0}</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <strong>Total Relationships:</strong><br>
                            <span style="font-size: 24px; color: #3498db;">${retrievalData.total_relationships || 0}</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <strong>Total Citations:</strong><br>
                            <span style="font-size: 24px; color: #2ecc71;">${citationCount}</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <strong>Citations with Quotes:</strong><br>
                            <span style="font-size: 24px; color: #2ecc71;">${quotesCount} / ${citationCount}</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <strong>Proof Chains:</strong><br>
                            <span style="font-size: 24px; color: #9b59b6;">${proofChainCount}</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <strong>Key Terms:</strong><br>
                            <span style="font-size: 16px; color: #555;">${(retrievalData.key_terms || []).join(', ')}</span>
                        </div>
                    </div>
                `;
                debugStats.innerHTML = html;
            }
        }
        
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>

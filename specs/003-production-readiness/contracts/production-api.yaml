openapi: 3.0.3
info:
  title: Tenant Legal Guidance System - Production API
  version: 1.0.0
  description: Production-ready API with security, rate limiting, and health checks
  contact:
    name: API Support

servers:
  - url: https://yourdomain.com
    description: Production server
  - url: http://localhost:8000
    description: Local development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Case Analysis
    description: Case evidence checking and analysis
  - name: Data Ingestion
    description: Data ingestion with validation
  - name: System
    description: System information endpoints

paths:
  /api/health:
    get:
      tags:
        - Health
      summary: Health check endpoint
      description: Returns the health status of the application and all dependencies
      operationId: healthCheck
      responses:
        '200':
          description: Health status response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'
              example:
                status: healthy
                timestamp: '2025-01-27T12:00:00Z'
                dependencies:
                  arangodb:
                    status: up
                    response_time_ms: 15.2
                    error: null
                    last_checked: '2025-01-27T12:00:00Z'
                  qdrant:
                    status: up
                    response_time_ms: 8.5
                    error: null
                    last_checked: '2025-01-27T12:00:00Z'
                  deepseek_api:
                    status: up
                    response_time_ms: 120.3
                    error: null
                    last_checked: '2025-01-27T12:00:00Z'
                version: '1.0.0'
        '503':
          description: Service unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'
              example:
                status: unhealthy
                timestamp: '2025-01-27T12:00:00Z'
                dependencies:
                  arangodb:
                    status: down
                    response_time_ms: null
                    error: 'Connection refused'
                    last_checked: '2025-01-27T12:00:00Z'
                version: '1.0.0'

  /api/analyze-case-enhanced:
    post:
      tags:
        - Case Analysis
      summary: Analyze case evidence and get next steps
      description: Primary use case - users submit their case and receive evidence analysis with next steps
      operationId: analyzeCaseEnhanced
      security:
        - {}  # No authentication required for web UI
        - ApiKeyAuth: []  # Optional API key authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CaseAnalysisRequest'
            example:
              case_text: "My landlord is refusing to make repairs after I reported mold."
              jurisdiction: "NYC"
      responses:
        '200':
          description: Case analysis with evidence and next steps
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed per minute
              schema:
                type: integer
            X-RateLimit-Remaining:
              description: Remaining requests in current window
              schema:
                type: integer
            X-RateLimit-Reset:
              description: Unix timestamp when limit resets
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CaseAnalysisResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/kg/process:
    post:
      tags:
        - Data Ingestion
      summary: Ingest new data into knowledge graph
      description: Primary use case - users submit data for ingestion, which is validated before adding to knowledge graph
      operationId: ingestData
      security:
        - {}  # No authentication required for web UI
        - ApiKeyAuth: []  # Optional API key authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DataIngestionRequest'
      responses:
        '200':
          description: Data ingestion initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataIngestionResponse'
        '400':
          description: Invalid request or validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '413':
          description: Request too large
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: Optional API key for programmatic access

  schemas:
    HealthCheckResponse:
      type: object
      required:
        - status
        - timestamp
        - dependencies
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          description: Overall health status
        timestamp:
          type: string
          format: date-time
          description: Timestamp of health check
        dependencies:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/DependencyStatus'
          description: Status of each dependency
        version:
          type: string
          description: Application version

    DependencyStatus:
      type: object
      required:
        - status
        - last_checked
      properties:
        status:
          type: string
          enum: [up, down, degraded]
          description: Dependency status
        response_time_ms:
          type: number
          nullable: true
          description: Response time in milliseconds
        error:
          type: string
          nullable: true
          description: Error message if status is down or degraded
        last_checked:
          type: string
          format: date-time
          description: When dependency was last checked

    CaseAnalysisRequest:
      type: object
      required:
        - case_text
      properties:
        case_text:
          type: string
          description: User's case description
          maxLength: 10000
        jurisdiction:
          type: string
          description: Jurisdiction (e.g., NYC, CA)
          default: NYC

    CaseAnalysisResponse:
      type: object
      properties:
        issues:
          type: array
          items:
            type: object
        evidence:
          type: array
          items:
            type: object
        next_steps:
          type: array
          items:
            type: string
        # Additional fields as per existing implementation

    DataIngestionRequest:
      type: object
      required:
        - source
      properties:
        source:
          type: string
          description: Source URL or text content
        source_type:
          type: string
          enum: [URL, TEXT, PDF]
          default: URL
        title:
          type: string
          description: Source title
        jurisdiction:
          type: string
          description: Jurisdiction

    DataIngestionResponse:
      type: object
      properties:
        status:
          type: string
          enum: [accepted, validation_failed, processing]
        message:
          type: string
          description: User-friendly status message
        validation_errors:
          type: array
          items:
            type: string
          description: Validation errors if validation_failed
        source_id:
          type: string
          description: Source ID if accepted

    ErrorResponse:
      type: object
      required:
        - error
        - request_id
      properties:
        error:
          type: string
          description: User-friendly error message (no technical details)
        request_id:
          type: string
          description: Request ID for support correlation
      example:
        error: "Service temporarily unavailable. Please try again later."
        request_id: "abc123def456"


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Graph Viewer</title>
    <!-- Import vis-network library -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Prevent body scrollbars */
            background-color: #f0f2f5;
        }
        h1, h2, h3 {
             color: #2c3e50;
             margin-top: 0;
        }
        .container {
            display: flex;
            height: 100vh; /* Full viewport height */
            width: 100%;
        }
        #graph-container {
            flex-grow: 1; /* Takes up remaining space */
            height: 100%;
            border-right: 2px solid #d1d9e6;
            background-color: #ffffff;
        }
        #sidebar {
            width: 350px; /* Fixed width for sidebar */
            flex-shrink: 0; /* Prevent sidebar from shrinking */
            height: 100%;
            overflow-y: auto; /* Allow scrolling within sidebar */
            background-color: #f8f9fa;
            padding: 20px;
            box-sizing: border-box; /* Include padding in width */
            display: flex;
            flex-direction: column;
        }
        #details-panel {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-shrink: 0; /* Prevent shrinking */
            max-height: 40%; /* Limit details panel height */
            overflow-y: auto; /* Scroll if content overflows */
        }
        #details-panel h3 {
             margin-bottom: 10px;
             padding-bottom: 5px;
             border-bottom: 1px solid #ced4da;
        }
         #details-panel p {
             margin: 5px 0;
             word-wrap: break-word; /* Wrap long text */
         }
         #details-panel code {
             background-color: #d1d9e6;
             padding: 2px 4px;
             border-radius: 3px;
             font-size: 0.9em;
         }

        #chat-container {
            flex-grow: 1; /* Takes remaining space in sidebar */
            display: flex;
            flex-direction: column;
            border: 1px solid #d1d9e6;
            border-radius: 8px;
            background-color: #fff;
            overflow: hidden; /* Clip content */
        }
        #chat-log {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .chat-message {
             margin-bottom: 10px;
             padding: 8px 12px;
             border-radius: 15px;
             max-width: 80%;
             word-wrap: break-word;
         }
         .user-message {
             background-color: #3498db;
             color: white;
             margin-left: auto; /* Align right */
             border-bottom-right-radius: 5px;
         }
         .bot-message {
             background-color: #ecf0f1;
             color: #333;
             margin-right: auto; /* Align left */
              border-bottom-left-radius: 5px;
         }
        #chat-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #d1d9e6;
            background-color: #f8f9fa;
        }
        #chat-input {
            flex-grow: 1;
            padding: 8px 10px;
            border: 1px solid #ced4da;
            border-radius: 15px;
            margin-right: 8px;
            font-size: 0.95rem;
        }
        #send-btn {
            padding: 8px 15px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
        }
         #send-btn:hover {
              background-color: #27ae60;
         }
         nav {
             position: absolute; /* Position nav on top */
             top: 0;
             left: 0;
             width: 100%;
             background: rgba(52, 73, 94, 0.85); /* Semi-transparent dark */
             padding: 8px 0;
             text-align: center;
             z-index: 10; /* Ensure nav is above graph */
         }
         nav a {
             color: white;
             text-decoration: none;
             margin: 0 15px;
             font-weight: bold;
             font-size: 0.9em;
         }
         nav a:hover {
             text-decoration: underline;
         }

        /* Actions panel */
        #actions-panel {
            background-color: #ffffff;
            border: 1px solid #d1d9e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        #actions-panel h3 {
            margin-top: 0;
            font-size: 1.05rem;
        }
        .actions-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .danger {
            background-color: #e74c3c;
            color: #fff;
        }
        .danger:disabled {
            background-color: #f1a9a0;
            cursor: not-allowed;
        }
        .hint {
            color: #6c757d;
            font-size: 0.85rem;
            margin: 0;
        }

    </style>
</head>
<body>
    <nav>
        <a href="/">Consultation Analyzer</a>
        <a href="/kg-input">KG Input</a>
        <a href="/kg-view">KG Viewer</a>
    </nav>
    <div class="container">
        <div id="graph-container"></div>
        <div id="sidebar">
            <h2>Graph Details & Chat</h2>
            <div id="actions-panel">
                <h3>Actions</h3>
                <div class="actions-row">
                    <button id="delete-node-btn" class="action-btn danger" disabled>Delete Node</button>
                    <button id="delete-selected-btn" class="action-btn danger" disabled>Delete Selected</button>
                    <button id="expand-btn" class="action-btn" disabled>Expand 1-hop</button>
                    <button id="consolidate-btn" class="action-btn" disabled>Consolidate</button>
                    <button id="consolidate-all-btn" class="action-btn">Consolidate All</button>
                </div>
                <div class="actions-row">
                    <input id="filter-q" placeholder="Search q" style="flex:1; padding:6px; border:1px solid #ced4da; border-radius:6px;" />
                    <input id="filter-types" placeholder="types (comma)" style="flex:1; padding:6px; border:1px solid #ced4da; border-radius:6px;" />
                </div>
                <div class="actions-row">
                    <input id="filter-jurisdiction" placeholder="jurisdiction" style="flex:1; padding:6px; border:1px solid #ced4da; border-radius:6px;" />
                    <button id="apply-filters-btn" class="action-btn">Apply Filters</button>
                    <button id="load-more-btn" class="action-btn">Load More</button>
                </div>
                <p class="hint">Tip: Hold Cmd/Ctrl or Shift to multi-select nodes.</p>
            </div>
            <div id="details-panel">
                <h3>Selection Details</h3>
                <p>Click on a node or edge to see details here.</p>
            </div>
            <div id="chat-container">
                <div id="chat-log">
                     <div class="bot-message">Hello! Ask me questions about the graph or selected items. (Editing not yet implemented).</div>
                </div>
                <div id="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Ask about the graph...">
                    <button id="send-btn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const graphContainer = document.getElementById('graph-container');
        const detailsPanel = document.getElementById('details-panel');
        const chatLog = document.getElementById('chat-log');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const deleteNodeBtn = document.getElementById('delete-node-btn');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const expandBtn = document.getElementById('expand-btn');
        const consolidateBtn = document.getElementById('consolidate-btn');
        const consolidateAllBtn = document.getElementById('consolidate-all-btn');

        let network = null;
        let graphData = { nodes: [], edges: [] }; // raw arrays
        let nodesDs = null; // vis DataSet for nodes
        let edgesDs = null; // vis DataSet for edges
        let selectedNodeId = null;
        let selectedEdgeId = null;
        let selectedNodeIds = new Set();
        let nextCursor = null;
        let activeFilters = { q: null, types: null, jurisdiction: null };

        // --- Entity Type Styling ---
        const entityColors = {
            TENANT_ISSUE: '#e74c3c',
            STATUTE: '#2980b9',
            REGULATION: '#3498db',
            CASE: '#f1c40f',
            REMEDY: '#2ecc71',
            EVIDENCE_TYPE: '#9b59b6',
            LEGAL_PROCEDURE: '#e67e22',
            LEGAL_CONCEPT: '#1abc9c',
            JURISDICTION: '#7f8c8d',
            TEXT_CHUNK: '#95a5a6',
            DEFAULT: '#bdc3c7',
        };

         const entityShapes = {
            TENANT_ISSUE: 'star',
            STATUTE: 'box',
            REGULATION: 'box',
            CASE: 'ellipse',
            REMEDY: 'diamond',
            EVIDENCE_TYPE: 'triangle',
            LEGAL_PROCEDURE: 'hexagon',
            LEGAL_CONCEPT: 'dot',
            JURISDICTION: 'square',
            TEXT_CHUNK: 'box',
            DEFAULT: 'ellipse'
         };

        function normalizeTypeKey(typeStr) {
            if (!typeStr) return 'DEFAULT';
            const upper = String(typeStr).toUpperCase();
            const map = {
                'TENANT_ISSUE': 'TENANT_ISSUE', 'tenant_issue': 'TENANT_ISSUE',
                'LAW': 'STATUTE', 'law': 'STATUTE',
                'REGULATION': 'REGULATION', 'regulation': 'REGULATION',
                'COURT_CASE': 'CASE', 'court_case': 'CASE',
                'REMEDY': 'REMEDY', 'remedy': 'REMEDY',
                'EVIDENCE': 'EVIDENCE_TYPE', 'evidence': 'EVIDENCE_TYPE',
                'LEGAL_PROCEDURE': 'LEGAL_PROCEDURE', 'legal_procedure': 'LEGAL_PROCEDURE',
                'LEGAL_CONCEPT': 'LEGAL_CONCEPT', 'legal_concept': 'LEGAL_CONCEPT',
                'JURISDICTION': 'JURISDICTION', 'jurisdiction': 'JURISDICTION',
                'TEXT_CHUNK': 'TEXT_CHUNK', 'text_chunk': 'TEXT_CHUNK'
            };
            return map[typeStr] || map[upper] || 'DEFAULT';
        }

        // --- Vis.js Network Initialization ---
        async function initializeGraph() {
            try {
                console.log("Fetching graph data (first page)...");
                nextCursor = null;
                const params = new URLSearchParams();
                params.set('limit', '200');
                if (activeFilters.q) params.set('q', activeFilters.q);
                if (activeFilters.types) params.set('types', activeFilters.types);
                if (activeFilters.jurisdiction) params.set('jurisdiction', activeFilters.jurisdiction);
                const graphResponse = await fetch(`/api/kg/graph-data?${params.toString()}`);
                
                if (!graphResponse.ok) {
                    throw new Error(`Graph data HTTP error! Status: ${graphResponse.status}`);
                }
                
                const rawData = await graphResponse.json();
                nextCursor = rawData.next_cursor ?? null;
                
                console.log(`Received ${rawData.nodes?.length} nodes, ${rawData.links?.length} links.`);

                // Process entity nodes for vis-network
                const entityNodes = rawData.nodes.map(node => ({
                    id: node.id,
                    label: node.label || node.name || node.id,
                    title: `Type: ${node.type}<br>ID: ${node.id}`,
                    shape: entityShapes[normalizeTypeKey(node.type)] || entityShapes.DEFAULT,
                    color: entityColors[normalizeTypeKey(node.type)] || entityColors.DEFAULT,
                    size: normalizeTypeKey(node.type) === 'TEXT_CHUNK' ? 12 : 20,
                    originalData: node
                }));

                // Combine all nodes
                const nodes = [...entityNodes];

                // Process entity relationships
                const entityEdges = rawData.links.map((link, index) => ({
                    id: `edge_${index}`,
                    from: link.source,
                    to: link.target,
                    label: link.label || '',
                    title: `Type: ${link.label}<br>Conditions: ${link.conditions || 'N/A'}`,
                    arrows: 'to',
                    font: { align: 'top' },
                    color: (link.label === 'MENTIONS') ? '#7f8c8d' : '#848484',
                    dashes: (link.label === 'MENTIONS'),
                    width: (link.label === 'MENTIONS') ? 1 : 1,
                    originalData: link
                }));

                // Combine all edges
                const edges = [...entityEdges];

                graphData = { nodes, edges }; // Store processed data

                const options = {
                    nodes: {
                        font: { size: 12, color: '#333' },
                        borderWidth: 1,
                         shapeProperties: {
                             useBorderWithImage: true
                         }
                    },
                    edges: {
                        width: 1,
                        color: '#848484',
                        smooth: {
                            type: 'continuous' // Makes edges curvier
                        },
                        font: {
                             size: 10,
                             color: '#555',
                             strokeWidth: 0 // No background for edge label
                         }
                    },
                    physics: {
                        enabled: true,
                        solver: 'forceAtlas2Based', // Good general-purpose layout
                         forceAtlas2Based: {
                             gravitationalConstant: -50,
                             centralGravity: 0.01,
                             springLength: 100,
                             springConstant: 0.08,
                             avoidOverlap: 0.5 // Increase to reduce overlap
                         },
                         stabilization: { iterations: 150 } // More iterations for stability
                    },
                    interaction: {
                         hover: true, // Show tooltips on hover
                         tooltipDelay: 200,
                         multiselect: true,
                         selectConnectedEdges: false,
                         keyboard: { enabled: true, bindToWindow: true }
                     },
                     layout: {
                         // randomSeed: 2 // Uncomment for reproducible layout (useful for debugging)
                     }
                };

                // Use DataSets so we can mutate graph after deletions
                nodesDs = new vis.DataSet(nodes);
                edgesDs = new vis.DataSet(edges);
                network = new vis.Network(graphContainer, { nodes: nodesDs, edges: edgesDs }, options);

                 // --- Event Listeners ---
                 network.on("click", function (params) { handleSelection(params); });
                 network.on("select", function () { handleSelection({ nodes: network.getSelectedNodes(), edges: network.getSelectedEdges() }); });
                 network.on("deselectNode", function () { handleSelection({ nodes: network.getSelectedNodes(), edges: network.getSelectedEdges() }); });
                 network.on("deselectEdge", function () { handleSelection({ nodes: network.getSelectedNodes(), edges: network.getSelectedEdges() }); });

                 network.on("stabilizationIterationsDone", function () {
                     console.log("Layout stabilization complete.");
                     network.stopSimulation(); // Optional: stop physics after stabilization
                     // network.fit(); // Fit graph to view
                 });

                console.log("Graph initialized.");

            } catch (error) {
                console.error("Error initializing graph:", error);
                try { console.error("Graph data raw error:", error?.stack || error); } catch(e) {}
                graphContainer.innerHTML = `<p style="color:red; padding: 20px;">Failed to load graph data: ${error.message}</p>`;
            }
        }

        async function loadMore() {
            try {
                if (nextCursor == null) return;
                const params = new URLSearchParams();
                params.set('limit', '200');
                params.set('cursor', String(nextCursor));
                if (activeFilters.q) params.set('q', activeFilters.q);
                if (activeFilters.types) params.set('types', activeFilters.types);
                if (activeFilters.jurisdiction) params.set('jurisdiction', activeFilters.jurisdiction);
                const resp = await fetch(`/api/kg/graph-data?${params.toString()}`);
                const page = await resp.json();
                if (!resp.ok) throw new Error(page && page.detail ? page.detail : 'Load more failed');
                nextCursor = page.next_cursor ?? null;

                const newNodes = page.nodes.map(node => ({
                    id: node.id,
                    label: node.label || node.name || node.id,
                    title: `Type: ${node.type}<br>ID: ${node.id}`,
                    shape: entityShapes[normalizeTypeKey(node.type)] || entityShapes.DEFAULT,
                    color: entityColors[normalizeTypeKey(node.type)] || entityColors.DEFAULT,
                    size: normalizeTypeKey(node.type) === 'TEXT_CHUNK' ? 12 : 20,
                    originalData: node
                }));
                const newEdges = page.links.map((link, index) => ({
                    id: `edge_more_${Date.now()}_${index}`,
                    from: link.source,
                    to: link.target,
                    label: link.label || '',
                    title: `Type: ${link.label}<br>Conditions: ${link.conditions || 'N/A'}`,
                    arrows: 'to',
                    font: { align: 'top' },
                    color: (link.label === 'MENTIONS') ? '#7f8c8d' : '#848484',
                    dashes: (link.label === 'MENTIONS'),
                    width: (link.label === 'MENTIONS') ? 1 : 1,
                    originalData: link
                }));

                // Insert into datasets while avoiding duplicate nodes
                const existingIds = new Set(nodesDs.getIds());
                const nodesToAdd = newNodes.filter(n => !existingIds.has(n.id));
                if (nodesToAdd.length) nodesDs.add(nodesToAdd);
                if (newEdges.length) edgesDs.add(newEdges);
            } catch (err) {
                console.error('Load more error:', err);
                alert(`Error: ${err.message || err}`);
            }
        }

        // --- Selection Handling ---
        function handleSelection(params) {
            selectedNodeId = null; // primary selected
            selectedEdgeId = null;
            selectedNodeIds = new Set(params.nodes || []);

            if (params.nodes && params.nodes.length > 0) {
                selectedNodeId = params.nodes[params.nodes.length - 1];
                const node = nodesDs ? nodesDs.get(selectedNodeId) : null;
                if (params.nodes.length === 1) {
                    displayNodeDetails(node);
                } else {
                    displayMultiSelectionDetails(params.nodes.length);
                }
            } else if (params.edges && params.edges.length > 0) {
                 selectedEdgeId = params.edges[0];
                 const edge = edgesDs ? edgesDs.get(selectedEdgeId) : null;
                 displayEdgeDetails(edge);
            } else {
                displayDefaultDetails();
            }
            updateActionButtons();
        }

        function displayNodeDetails(node) {
            if (!node || !node.originalData) {
                displayDefaultDetails();
                return;
            }
            const data = node.originalData;
            
            // Regular entity display
            let detailsHtml = `<h3>Entity Details: ${escapeHtml(data.label || data.id)}</h3>`;
            detailsHtml += `<p><strong>ID:</strong> <code>${escapeHtml(data.id)}</code></p>`;
            detailsHtml += `<p><strong>Type:</strong> ${escapeHtml(data.type)}</p>`;
            if (normalizeTypeKey(data.type) === 'TEXT_CHUNK') {
                const src = (data.source_metadata && data.source_metadata.source) ? String(data.source_metadata.source) : '';
                const link = (src.startsWith('http://') || src.startsWith('https://')) ? `<a href="${escapeHtml(src)}" target="_blank">${escapeHtml(src)}</a>` : escapeHtml(src);
                const text = (data.attributes && data.attributes.text) ? String(data.attributes.text) : '';
                const snippet = text.length > 800 ? (text.slice(0, 800) + '…') : text;
                detailsHtml += `<p><strong>Source:</strong> ${link}</p>`;
                detailsHtml += `<p><strong>Chunk Index:</strong> ${escapeHtml(String(data.attributes && data.attributes.chunk_index || '0'))}</p>`;
                detailsHtml += `<div style="margin-top:8px; padding:8px; background:#fff; border:1px solid #ddd; border-radius:6px; max-height:220px; overflow:auto;"><strong>Text:</strong><br><span style="white-space:pre-wrap;">${escapeHtml(snippet)}</span></div>`;
                detailsPanel.innerHTML = detailsHtml;
                return;
            }
            if (data.description) {
                detailsHtml += `<p><strong>Description:</strong> ${escapeHtml(data.description)}</p>`;
            }
            if (data.jurisdiction) {
                 detailsHtml += `<p><strong>Jurisdiction:</strong> <code>${escapeHtml(data.jurisdiction)}</code></p>`;
            }
            if (data.source_metadata) {
                const sm = data.source_metadata;
                const srcType = sm.source_type || 'N/A';
                const src = sm.source || '';
                const sourceText = (typeof src === 'string' && (src.startsWith('http://') || src.startsWith('https://')))
                    ? `<a href="${escapeHtml(src)}" target="_blank">${escapeHtml(src)}</a>`
                    : escapeHtml(String(src || ''));
                detailsHtml += `<p><strong>Source (${escapeHtml(String(srcType))}):</strong> ${sourceText}</p>`;
                if (sm.title) detailsHtml += `<p><strong>Title:</strong> ${escapeHtml(String(sm.title))}</p>`;
                if (sm.organization) detailsHtml += `<p><strong>Organization:</strong> ${escapeHtml(String(sm.organization))}</p>`;
                if (sm.created_at) detailsHtml += `<p><strong>Created:</strong> ${escapeHtml(String(sm.created_at))}</p>`;
            }
            if (typeof data.mentions_count === 'number') {
                detailsHtml += `<p><strong>Mentions:</strong> ${data.mentions_count}</p>`;
            }
            if (Array.isArray(data.provenance) && data.provenance.length > 0) {
                detailsHtml += `<p><strong>Provenance:</strong></p><ul>`;
                (data.provenance.slice(0, 5)).forEach((p, i) => {
                    const src = p && p.source ? p.source.source : '';
                    const link = (typeof src === 'string' && (src.startsWith('http://') || src.startsWith('https://')))
                        ? `<a href="${escapeHtml(src)}" target="_blank">${escapeHtml(src)}</a>`
                        : escapeHtml(String(src || ''));
                    const quote = p && p.quote ? escapeHtml(p.quote) : '';
                    detailsHtml += `<li>${link}${quote ? `<div style="margin-top:4px;font-size:0.9em;color:#444;">“${quote}”</div>` : ''}</li>`;
                });
                if (data.provenance.length > 5) {
                    detailsHtml += `<li>… and ${data.provenance.length - 5} more</li>`;
                }
                detailsHtml += `</ul>`;
            }
            if (data.attributes && Object.keys(data.attributes).length > 0) {
                 detailsHtml += `<p><strong>Attributes:</strong></p><ul>`;
                 for (const [key, value] of Object.entries(data.attributes)) {
                     detailsHtml += `<li><code>${escapeHtml(key)}</code>: ${escapeHtml(JSON.stringify(value))}</li>`;
                 }
                 detailsHtml += `</ul>`;
            }
            detailsPanel.innerHTML = detailsHtml;
        }

        function displayMultiSelectionDetails(count) {
            detailsPanel.innerHTML = `<h3>Multiple Selection</h3><p>${count} nodes selected.</p>`;
        }

        function displayDefaultDetails() {
            detailsPanel.innerHTML = '<h3>Selection Details</h3><p>Click on a node or edge to see details here.</p>';
        }

        // --- Actions ---
        function updateActionButtons() {
            const count = selectedNodeIds.size;
            deleteSelectedBtn.disabled = count === 0;
            deleteNodeBtn.disabled = count !== 1;
            expandBtn.disabled = count === 0;
            consolidateBtn.disabled = count < 2;
        }

        deleteNodeBtn.addEventListener('click', async () => {
            const ids = Array.from(selectedNodeIds);
            if (ids.length !== 1) return;
            await deleteNodes(ids);
        });

        deleteSelectedBtn.addEventListener('click', async () => {
            const ids = Array.from(selectedNodeIds);
            if (ids.length === 0) return;
            await deleteNodes(ids);
        });

        expandBtn.addEventListener('click', async () => {
            const ids = Array.from(selectedNodeIds);
            if (ids.length === 0) return;
            await expandNeighbors(ids);
        });

        consolidateBtn.addEventListener('click', async () => {
            const ids = Array.from(selectedNodeIds);
            if (ids.length < 2) return;
            await consolidateNodes(ids);
        });

        consolidateAllBtn.addEventListener('click', async () => {
            try {
                if (!confirm('Consolidate the entire graph (strict match)? This may merge close duplicates.')) return;
                const resp = await fetch('/api/kg/consolidate-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threshold: 0.97 })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data && data.detail ? data.detail : 'Consolidate-all failed');
                alert('Consolidate-all completed');
                initializeGraph();
            } catch (err) {
                console.error('Consolidate-all error:', err);
                alert(`Error: ${err.message || err}`);
            }
        });

        // Filters & Load More
        document.getElementById('apply-filters-btn').addEventListener('click', async () => {
            activeFilters.q = (document.getElementById('filter-q').value || '').trim() || null;
            activeFilters.types = (document.getElementById('filter-types').value || '').trim() || null;
            activeFilters.jurisdiction = (document.getElementById('filter-jurisdiction').value || '').trim() || null;
            await initializeGraph();
        });
        document.getElementById('load-more-btn').addEventListener('click', loadMore);

        async function deleteNodes(nodeIds) {
            try {
                // Filter out concept group nodes (front-end only constructs)
                const entityIds = nodeIds.filter(id => {
                    const n = nodesDs.get(id);
                    return n && !(n.originalData && n.originalData.isConceptGroup);
                });

                if (entityIds.length === 0) {
                    alert('No deletable entities selected. Concept groups cannot be deleted.');
                    return;
                }

                const confirmMsg = entityIds.length === 1 ?
                    `Delete node "${entityIds[0]}" and its relationships?` :
                    `Delete ${entityIds.length} nodes and their relationships?`;
                if (!confirm(confirmMsg)) return;

                let response;
                if (entityIds.length === 1) {
                    response = await fetch(`/api/kg/entities/${encodeURIComponent(entityIds[0])}`, { method: 'DELETE' });
                } else {
                    response = await fetch('/api/kg/entities/delete-bulk', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: entityIds })
                    });
                }
                const result = await response.json();
                if (!response.ok) {
                    const msg = result && result.detail ? result.detail : 'Delete failed';
                    throw new Error(msg);
                }

                // Remove nodes and incident edges from the visualization
                const toRemove = new Set(entityIds);
                // Remove edges first
                const incidentEdges = edgesDs.get({ filter: e => toRemove.has(e.from) || toRemove.has(e.to) }).map(e => e.id);
                if (incidentEdges.length) edgesDs.remove(incidentEdges);
                // Remove nodes
                nodesDs.remove(entityIds);

                // Clear selection and details
                selectedNodeIds.clear();
                selectedNodeId = null;
                selectedEdgeId = null;
                network.unselectAll();
                displayDefaultDetails();
                updateActionButtons();
            } catch (err) {
                console.error('Delete error:', err);
                alert(`Error: ${err.message || err}`);
            }
        }

        async function expandNeighbors(nodeIds) {
            try {
                const resp = await fetch('/api/kg/expand', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ node_ids: nodeIds })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data && data.detail ? data.detail : 'Expand failed');
                alert(`Expanded: ${data.expanded || 0} (examined ${data.examined || 0})`);
                // Reload the graph to reflect expanded nodes/edges
                initializeGraph();
            } catch (err) {
                console.error('Expand error:', err);
                alert(`Error: ${err.message || err}`);
            }
        }

        async function consolidateNodes(nodeIds) {
            try {
                const resp = await fetch('/api/kg/consolidate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ node_ids: nodeIds, threshold: 0.95 })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data && data.detail ? data.detail : 'Consolidate failed');
                alert(`Consolidated: ${data.merged || 0} (examined ${data.examined || 0})`);
                // Reload the graph to reflect merged nodes/edges
                initializeGraph();
            } catch (err) {
                console.error('Consolidate error:', err);
                alert(`Error: ${err.message || err}`);
            }
        }

        // --- Chat Functionality (Placeholder) ---
        sendBtn.addEventListener('click', handleChatSend);
        chatInput.addEventListener('keypress', function (e) {
             if (e.key === 'Enter') {
                 handleChatSend();
             }
        });

        async function handleChatSend() {
            const message = chatInput.value.trim();
            if (!message) return;

            appendChatMessage(message, 'user');
            chatInput.value = ''; // Clear input

            appendChatMessage('Thinking...', 'bot', true); // Indicate bot is processing

            try {
                // --- Make the actual API call --- 
                console.log(`Sending message: ${message}, Context ID: ${selectedNodeId || selectedEdgeId}`);
                const apiResponse = await fetch('/api/kg/chat', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        message: message, 
                        context_id: selectedNodeId || null
                    })
                });
                let result = {};
                try { result = await apiResponse.json(); } catch (e) { result = {}; }
                if (!apiResponse.ok) { 
                    const errorDetail = result.detail || `Chat API Error: ${apiResponse.status}`;
                    throw new Error(errorDetail);
                }
                const botResponse = result.response || "Sorry, I received an empty response.";
                removeLoadingMessage();
                appendChatMessage(botResponse, 'bot');
            } catch (error) {
                console.error("Chat API error:", error);
                removeLoadingMessage();
                appendChatMessage(`Error: ${error.message}`, 'bot', false, true);
            }
        }

        function appendChatMessage(text, sender, isLoading = false, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
            if (isLoading) messageDiv.classList.add('loading-message');
            if (isError) messageDiv.style.backgroundColor = '#fdedec';
            messageDiv.textContent = text;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingMsg = chatLog.querySelector('.loading-message');
            if (loadingMsg) {
                loadingMsg.remove();
            }
        }

        // --- Utility: HTML Escaping ---
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', initializeGraph);

    </script>
</body>
</html>
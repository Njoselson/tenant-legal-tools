<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant Legal Guidance - Consultation Analyzer</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 15px;
            background-color: #f8f9fa;
        }
        h1, h2 {
            color: #2c3e50;
        }
        h1 {
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 10px;
            text-align: center;
        }
        h2 {
             margin-top: 0;
             padding-bottom: 8px;
             border-bottom: 1px solid #eee;
        }
        #notes-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        #notes {
            width: 98%; /* Slightly less than 100% to account for padding/border */
            min-height: 250px;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-size: 1rem;
            margin-bottom: 15px;
            resize: vertical; /* Allow vertical resizing */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        #summarize-btn {
            display: block; /* Make button block level */
            width: 100%; /* Make button full width */
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 25px; /* Add space below button */
        }
        #summarize-btn:hover:not(:disabled) {
            background-color: #2980b9;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
         #summarize-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        #summary-output {
            margin-top: 30px;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #ecf0f1;
            min-height: 50px; /* Visible when empty/loading */
        }

        #summary-output ul {
            list-style: none;
            padding-left: 5px; /* Small indent */
        }
        #summary-output li {
            margin-bottom: 10px;
            padding-left: 1.5em;
            position: relative;
            line-height: 1.5;
        }
         /* Style bullet points */
        #summary-output .summary-section ul > li::before {
            content: "‚Ä¢"; /* Use literal bullet character */
            color: #3498db;
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1.5em; /* Align with text */
            position: absolute;
            left: 0;
        }
         /* Style numbered list for action items */
        #summary-output .action-items-list > li::before {
             content: counter(item) "."; /* Use counter for numbering */
             counter-increment: item;
             color: #2c3e50; /* Darker color for numbers */
             font-weight: bold;
             position: absolute;
             left: 0;
             width: 1.5em; /* Ensure space for number */
             text-align: right;
             margin-right: 0.5em;
             margin-left: -1.8em; /* Adjust alignment */
        }
         #summary-output .action-items-list {
             counter-reset: item; /* Reset counter for each list */
             padding-left: 1.8em; /* Make space for numbers */
         }

        #summary-output strong { /* For bolding parts like numbers or headers */
            color: #2c3e50;
        }
        .loading, .error {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #7f8c8d;
            font-size: 1.1em;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .summary-section {
             margin-bottom: 25px;
             padding-bottom: 15px;
             border-bottom: 1px dashed #ecf0f1; /* Separator */
        }
         .summary-section:last-child {
             border-bottom: none; /* No border for the last section */
             margin-bottom: 0;
         }
         .summary-section h3 { /* Sub-headings like Key Facts */
             color: #34495e;
             margin-top: 15px;
             margin-bottom: 10px;
             font-size: 1.1em;
         }
    </style>
</head>
<body>

    <div style="text-align: center; margin-bottom: 30px;">
        <h1>Tenant Legal Guidance System</h1>
        <nav style="margin: 20px 0;">
            <a href="/" style="margin: 0 15px; padding: 8px 16px; background: #3498db; color: white; text-decoration: none; border-radius: 4px;">üè† Home</a>
            <a href="/concept-groups" style="margin: 0 15px; padding: 8px 16px; background: #2ecc71; color: white; text-decoration: none; border-radius: 4px;">üß† Concept Groups</a>
            <a href="/kg-view" style="margin: 0 15px; padding: 8px 16px; background: #e74c3c; color: white; text-decoration: none; border-radius: 4px;">üìä Knowledge Graph</a>
        </nav>
    </div>
    
    <h2>Consultation Analyzer</h2>
    <p>Enter the notes from your consultation with the tenant union or legal clinic below. The system will summarize the discussion, identify next steps, and suggest relevant legal concepts.</p>

    <label for="notes" id="notes-label">Consultation Notes:</label>
    <textarea id="notes" placeholder="Paste or type your consultation notes here..."></textarea>
    <button id="summarize-btn">Analyze Notes</button>

    <div id="summary-output">
        <!-- Summary will appear here -->
    </div>

    <script>
        const notesInput = document.getElementById('notes');
        const summarizeBtn = document.getElementById('summarize-btn');
        const summaryOutput = document.getElementById('summary-output');

        summarizeBtn.addEventListener('click', async () => {
            const notes = notesInput.value.trim();
            if (!notes) {
                summaryOutput.innerHTML = '<p class="error">Please enter some notes before analyzing.</p>';
                return;
            }

            summaryOutput.innerHTML = '<p class="loading">Analyzing notes, please wait...</p>';
            summarizeBtn.disabled = true;
            summarizeBtn.textContent = 'Analyzing...'; // Change button text

            try {
                const response = await fetch('/api/analyze-consultation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json' // Explicitly accept JSON
                    },
                    body: JSON.stringify({ notes: notes })
                });

                if (!response.ok) {
                    let errorMsg = `API Error (${response.status})`;
                    try {
                         const errData = await response.json();
                         // Use the detail field from FastAPI's HTTPException or a default message
                         errorMsg += `: ${errData.detail || response.statusText || 'Unknown API error'}`;
                    } catch (jsonError) {
                        // If the error response itself isn't JSON
                        errorMsg += ` - Server returned non-JSON error response.`;
                        console.error("Non-JSON error response:", await response.text());
                    }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                displaySummary(data);

            } catch (error) {
                console.error('Error fetching or processing summary:', error);
                summaryOutput.innerHTML = `<p class="error">An error occurred: ${error.message}</p>`;
            } finally {
                 summarizeBtn.disabled = false;
                 summarizeBtn.textContent = 'Analyze Notes'; // Reset button text
            }
        });

        function displaySummary(data) {
            let html = '';

            // 1. Consultation Recap (Key Facts & Legal Issues)
            if (data.summary && data.summary.consultation_recap) {
                const recap = data.summary.consultation_recap;
                let recapHtml = '';
                if (recap.key_facts && recap.key_facts.length > 0) {
                    recapHtml += '<h3>Key Facts Discussed:</h3><ul>';
                    recap.key_facts.forEach(fact => {
                        recapHtml += `<li>${escapeHtml(fact)}</li>`;
                    });
                    recapHtml += '</ul>';
                }
                 if (recap.legal_issues_identified && recap.legal_issues_identified.length > 0) {
                    recapHtml += '<h3>Legal Issues Identified:</h3><ul>';
                    recap.legal_issues_identified.forEach(issue => {
                        recapHtml += `<li>${escapeHtml(issue)}</li>`;
                    });
                    recapHtml += '</ul>';
                }
                if (recapHtml) {
                     html += '<div class="summary-section">';
                     html += '<h2>‚úÖ What Was Discussed</h2>';
                     html += recapHtml;
                     html += '</div>';
                }
            }

            // 2. Action Items
            if (data.action_items && data.action_items.length > 0) {
                html += '<div class="summary-section">';
                // Use a specific class for the action items list for numbering
                html += '<h2>üìù Next Steps</h2><ul class="action-items-list">';
                data.action_items.forEach((item) => {
                    // No need for manual numbering, CSS counter will handle it
                    html += `<li>${escapeHtml(item)}</li>`;
                });
                html += '</ul></div>';
            }

            // 3. Legal Rights (from KG) - Renamed for clarity
             if (data.legal_rights && data.legal_rights.length > 0) {
                html += '<div class="summary-section">';
                html += '<h2>‚öñÔ∏è Relevant Legal Concepts</h2><ul>';
                data.legal_rights.forEach(right => {
                    html += `<li>${escapeHtml(right)}</li>`;
                });
                html += '</ul><p><small>Note: These are potential concepts based on notes analysis and may require further legal verification.</small></p></div>';
            }

             // 4. Deadlines (if any)
             if (data.deadlines && data.deadlines.length > 0) {
                html += '<div class="summary-section">';
                html += '<h2>üìÖ Identified Deadlines</h2><ul>';
                data.deadlines.forEach(deadline => {
                    html += `<li><strong>${escapeHtml(deadline.deadline || 'Date N/A')}:</strong> ${escapeHtml(deadline.task || 'Task N/A')} (${escapeHtml(deadline.priority || 'Priority N/A')})</li>`;
                });
                html += '</ul></div>';
            }

            // Note: Legal Recourse & Likely Outcomes are not currently generated by the API
            // You would add sections here if the API provided that data in the future.
            // html += '<h2>‚öñÔ∏è Legal Recourse:</h2><ul>...</ul>';
            // html += '<h2>üìä Likely Outcomes if You Sue:</h2><ul>...</ul>';


            // 5. Templates (if any)
            if (data.templates && data.templates.length > 0) {
                html += '<div class="summary-section">';
                html += '<h2>üìÑ Available Templates</h2><ul>';
                data.templates.forEach(template => {
                    html += `<li><strong>${escapeHtml(template.name)}:</strong> ${escapeHtml(template.description)} (ID: ${escapeHtml(template.template_id)})</li>`;
                });
                html += '</ul></div>';
            }

            if (!html) { // If no sections were generated at all
                 html = '<p>Analysis complete. No specific summary sections could be generated from the provided notes.</p>';
            }

            summaryOutput.innerHTML = html;
        }

        // Basic HTML escaping function to prevent XSS
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') {
                console.warn("Attempted to escape non-string value:", unsafe);
                return unsafe; // Handle non-strings gracefully
            }
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
         }

    </script>

</body>
</html>
